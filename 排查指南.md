# 敏感信息文件未生成 - 排查指南

## 第一步：确认程序是最新版本

```bash
# 检查编译时间
dir spider.exe | findstr /C:"spider.exe"

# 如果不是最新的，重新编译
go build -o spider.exe cmd/spider/main.go
```

## 第二步：运行测试脚本

```bash
# 运行自动测试
test_local_sensitive.bat
```

这个测试使用包含已知敏感信息的HTML文件，**应该 100% 检测到**。

### 预期结果：

**✅ 成功的输出：**
```
✅ 已加载敏感信息规则文件: ./sensitive_rules_config.json

[*] 开始爬取: file:///C:/Users/.../test_sensitive.html

[敏感信息] ⚠️  发现 5 处高危敏感信息！
[敏感信息] 发现 3 处中危敏感信息

✅ 找到敏感信息文件！修复成功！
```

**❌ 问题1：规则文件加载失败**
```
⚠️  警告: 加载敏感规则失败: 读取规则文件失败: ...
```

**解决方案：**
```bash
# 检查规则文件是否存在
dir sensitive_rules_config.json

# 如果不存在，检查其他规则文件
dir sensitive_rules*.json

# 使用存在的规则文件
spider.exe -url https://example.com -sensitive-rules sensitive_rules_standard.json
```

**❌ 问题2：没有看到规则加载提示**

说明代码可能没有更新，重新编译：
```bash
go build -o spider.exe cmd/spider/main.go
```

## 第三步：检查配置文件

如果使用了配置文件（`-config xxx.json`），检查配置中的敏感信息检测设置：

```json
{
  "SensitiveDetectionSettings": {
    "Enabled": true,                    // ← 必须是 true
    "ScanResponseBody": true,           // ← 必须是 true
    "ScanResponseHeaders": true,
    "MinSeverity": "LOW",               // ← 不要设置为 HIGH
    "OutputFile": "",                   // ← 留空即可
    "RealTimeOutput": true,
    "RulesFile": "./sensitive_rules_config.json"  // ← 规则文件路径
  }
}
```

## 第四步：查看完整的启动输出

运行爬虫并保存输出：

```bash
spider.exe -url https://example.com > output.txt 2>&1
```

然后发送 `output.txt` 的内容，我可以帮您分析问题。

## 第五步：常见误区

### 误区1：目标网站确实没有敏感信息

**验证方法：**
使用测试HTML文件（`test_local_sensitive.bat`）。如果测试文件能检测到，说明程序正常，只是目标网站没有敏感信息。

### 误区2：扫描的页面太少

如果只爬取了首页，可能不会发现敏感信息。尝试增加深度：

```bash
spider.exe -url https://example.com -depth 5 -max-pages 500
```

### 误区3：使用了 -sensitive-detect=false

检查是否不小心禁用了功能：

```bash
# 错误示例（禁用了检测）
spider.exe -url https://example.com -sensitive-detect=false

# 正确示例（启用检测）
spider.exe -url https://example.com
# 或
spider.exe -url https://example.com -sensitive-detect=true
```

### 误区4：最低严重级别设置过高

如果设置了 `-sensitive-min-severity HIGH`，只会显示高危发现。尝试：

```bash
spider.exe -url https://example.com -sensitive-min-severity LOW
```

## 第六步：手动检查敏感信息检测器

运行以下调试命令：

```bash
spider.exe -url https://example.com -log-level debug > debug.log 2>&1
```

然后搜索 `debug.log` 中的关键词：
- "已加载敏感信息规则文件"
- "敏感规则"
- "sensitive"

## 第七步：检查文件生成逻辑

查看扫描完成后的统计信息，确认是否有这行：

```
✅ 敏感信息报告已保存: spider_xxx_sensitive.txt
```

如果有这行但找不到文件，可能是权限问题或路径问题。

检查当前目录：
```bash
dir /B spider_*_sensitive.*
```

## 第八步：验证规则文件格式

确认规则文件是有效的JSON：

```bash
# 使用PowerShell验证
Get-Content sensitive_rules_config.json | ConvertFrom-Json
```

如果报错，说明规则文件格式有问题。

## 快速诊断命令

复制粘贴运行以下命令，一键检查所有环节：

```powershell
Write-Host "=== 敏感信息检测诊断 ===" -ForegroundColor Cyan

# 1. 检查规则文件
Write-Host "`n[1/6] 检查规则文件..." -ForegroundColor Yellow
if (Test-Path sensitive_rules_config.json) {
    Write-Host "  ✓ sensitive_rules_config.json 存在" -ForegroundColor Green
    try {
        Get-Content sensitive_rules_config.json | ConvertFrom-Json | Out-Null
        Write-Host "  ✓ JSON格式有效" -ForegroundColor Green
    } catch {
        Write-Host "  ✗ JSON格式无效: $_" -ForegroundColor Red
    }
} else {
    Write-Host "  ✗ sensitive_rules_config.json 不存在" -ForegroundColor Red
}

# 2. 检查可执行文件
Write-Host "`n[2/6] 检查可执行文件..." -ForegroundColor Yellow
if (Test-Path spider.exe) {
    $file = Get-Item spider.exe
    Write-Host "  ✓ spider.exe 存在" -ForegroundColor Green
    Write-Host "  最后修改时间: $($file.LastWriteTime)" -ForegroundColor Gray
} else {
    Write-Host "  ✗ spider.exe 不存在" -ForegroundColor Red
}

# 3. 检查测试文件
Write-Host "`n[3/6] 检查测试文件..." -ForegroundColor Yellow
if (Test-Path test_sensitive.html) {
    Write-Host "  ✓ test_sensitive.html 存在" -ForegroundColor Green
} else {
    Write-Host "  ! test_sensitive.html 不存在，需要创建" -ForegroundColor Yellow
}

# 4. 检查之前的敏感信息文件
Write-Host "`n[4/6] 检查历史敏感信息文件..." -ForegroundColor Yellow
$sensitiveFiles = Get-ChildItem -Filter "*_sensitive.*" -ErrorAction SilentlyContinue
if ($sensitiveFiles.Count -gt 0) {
    Write-Host "  ✓ 找到 $($sensitiveFiles.Count) 个敏感信息文件:" -ForegroundColor Green
    $sensitiveFiles | ForEach-Object {
        Write-Host "    - $($_.Name) ($(Get-Date $_.LastWriteTime -Format 'yyyy-MM-dd HH:mm:ss'))" -ForegroundColor Gray
    }
} else {
    Write-Host "  ! 未找到任何敏感信息文件" -ForegroundColor Yellow
}

# 5. 运行版本检查
Write-Host "`n[5/6] 检查程序版本..." -ForegroundColor Yellow
Write-Host "  运行: spider.exe -version" -ForegroundColor Gray
& .\spider.exe -version 2>&1 | Out-Null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  ✓ 程序可以正常运行" -ForegroundColor Green
} else {
    Write-Host "  ! 程序运行可能有问题" -ForegroundColor Yellow
}

# 6. 建议
Write-Host "`n[6/6] 建议..." -ForegroundColor Yellow
Write-Host "  1. 运行测试: .\test_local_sensitive.bat" -ForegroundColor Cyan
Write-Host "  2. 如果测试失败，重新编译: go build -o spider.exe cmd/spider/main.go" -ForegroundColor Cyan
Write-Host "  3. 查看详细日志: .\spider.exe -url <target> -log-level debug" -ForegroundColor Cyan

Write-Host "`n=== 诊断完成 ===" -ForegroundColor Cyan
```

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：

1. 运行 `spider.exe -version` 的输出
2. 运行 `test_local_sensitive.bat` 的完整输出
3. 运行爬虫的命令和完整输出
4. `dir sensitive_rules*.json` 的输出

这样我可以更准确地帮您定位问题。

