# Spider-golang æ”¹è¿›å®æ–½è®¡åˆ’

## ğŸ“Œ æ€»è§ˆ

æœ¬è®¡åˆ’æ—¨åœ¨ç³»ç»Ÿæ€§åœ°æå‡ Spider-golang çš„ä»£ç è´¨é‡ã€ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œä½¿å…¶è¾¾åˆ°ç”Ÿäº§çº§åˆ«æ ‡å‡†ã€‚

---

## ğŸ¯ æ”¹è¿›ç›®æ ‡

1. âœ… **æ¶ˆé™¤èµ„æºæ³„æ¼** - é˜²æ­¢å†…å­˜æ³„æ¼å’Œ goroutine æ³„æ¼
2. âœ… **å®Œå–„é”™è¯¯å¤„ç†** - å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
3. âœ… **å¼•å…¥ç»“æ„åŒ–æ—¥å¿—** - ä¾¿äºè°ƒè¯•å’Œç›‘æ§
4. âœ… **æ·»åŠ ç›‘æ§æŒ‡æ ‡** - å®æ—¶äº†è§£çˆ¬è™«è¿è¡ŒçŠ¶æ€
5. âœ… **æå‡ä»£ç è´¨é‡** - éµå¾ª Go æœ€ä½³å®è·µ

---

## ğŸ“‹ é˜¶æ®µä¸€ï¼šç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰

### ä¼˜å…ˆçº§ P0 - ç«‹å³æ‰§è¡Œ

#### 1.1 ä¿®å¤èµ„æºæ³„æ¼ â° 4å°æ—¶

**æ–‡ä»¶**: `core/spider.go`

**é—®é¢˜**:
- Channel æœªå…³é—­
- Goroutine æœªç­‰å¾…
- Context æœªå–æ¶ˆ

**ä¿®å¤æ­¥éª¤**:
```go
// 1. æ·»åŠ å­—æ®µ
type Spider struct {
    // ... ç°æœ‰å­—æ®µ
    done   chan struct{}
    ctx    context.Context
    cancel context.CancelFunc
    wg     sync.WaitGroup
}

// 2. åœ¨ NewSpider ä¸­åˆå§‹åŒ–
func NewSpider(cfg *config.Config) *Spider {
    ctx, cancel := context.WithCancel(context.Background())
    
    spider := &Spider{
        // ... ç°æœ‰åˆå§‹åŒ–
        ctx:    ctx,
        cancel: cancel,
        done:   make(chan struct{}),
    }
    return spider
}

// 3. åœ¨ Start ä¸­æ·»åŠ æ¸…ç†
func (s *Spider) Start(targetURL string) error {
    defer s.cleanup()
    
    // ... ç°æœ‰ä»£ç 
    return nil
}

// 4. æ·»åŠ æ¸…ç†æ–¹æ³•
func (s *Spider) cleanup() {
    s.cancel()
    s.wg.Wait()
    close(s.done)
}

// 5. å®ç° Close æ–¹æ³•
func (s *Spider) Close() error {
    s.cleanup()
    return nil
}
```

**éªŒè¯**: 
- è¿è¡Œçˆ¬è™«åæ£€æŸ¥ goroutine æ•°é‡: `go tool pprof`
- ä½¿ç”¨ `-race` æ ‡å¿—ç¼–è¯‘æ£€æµ‹ç«æ€

---

#### 1.2 ä¿®å¤ Context ç”Ÿå‘½å‘¨æœŸ â° 2å°æ—¶

**æ–‡ä»¶**: `core/dynamic_crawler.go`

**ä¿®å¤**:
```go
// åˆ é™¤æ„é€ å‡½æ•°ä¸­çš„ context
func NewDynamicCrawler() *DynamicCrawlerImpl {
    return &DynamicCrawlerImpl{
        timeout:      180 * time.Second,
        // ä¸å†å­˜å‚¨ ctx å’Œ cancel
    }
}

// æ¯æ¬¡ Crawl åˆ›å»ºæ–° context
func (d *DynamicCrawlerImpl) Crawl(targetURL *url.URL) (*Result, error) {
    ctx, cancel := context.WithTimeout(context.Background(), d.timeout)
    defer cancel()
    
    // ä½¿ç”¨ ctx è¿›è¡Œæ“ä½œ
    // ...
}
```

---

#### 1.3 ç»Ÿä¸€é”™è¯¯å¤„ç† â° 3å°æ—¶

**æ–°å»ºæ–‡ä»¶**: `core/errors.go`

```go
package core

import "errors"

var (
    ErrInvalidURL    = errors.New("æ— æ•ˆçš„URL")
    ErrTimeout       = errors.New("è¯·æ±‚è¶…æ—¶")
    ErrRateLimited   = errors.New("è¯·æ±‚è¢«é™æµ")
    ErrForbidden     = errors.New("è®¿é—®è¢«ç¦æ­¢")
    ErrServerError   = errors.New("æœåŠ¡å™¨é”™è¯¯")
)

type CrawlError struct {
    URL        string
    Err        error
    StatusCode int
    Retryable  bool
}

func (e *CrawlError) Error() string {
    return fmt.Sprintf("çˆ¬å–å¤±è´¥ [%s]: %v (çŠ¶æ€ç : %d)", 
        e.URL, e.Err, e.StatusCode)
}

func (e *CrawlError) Unwrap() error {
    return e.Err
}
```

**æ›´æ–°**: æ‰€æœ‰è¿”å›é”™è¯¯çš„åœ°æ–¹æ”¹ç”¨å®šä¹‰çš„é”™è¯¯ç±»å‹

---

#### 1.4 ä¿®å¤å¹¶å‘å®‰å…¨é—®é¢˜ â° 2å°æ—¶

**æ–‡ä»¶**: `core/spider.go`

**ä¿®å¤æ‰€æœ‰ç«æ€æ¡ä»¶**:
```go
// âŒ Bad
if len(s.results) > 0 {
    s.mutex.Lock()
    s.results[0].Links = append(...)
    s.mutex.Unlock()
}

// âœ… Good
s.mutex.Lock()
if len(s.results) > 0 {
    s.results[0].Links = append(...)
}
s.mutex.Unlock()
```

**éªŒè¯**: è¿è¡Œ `go run -race cmd/spider/main.go`

---

## ğŸ“‹ é˜¶æ®µäºŒï¼šè´¨é‡æå‡ï¼ˆ3-5å¤©ï¼‰

### ä¼˜å…ˆçº§ P1 - å°½å¿«å®Œæˆ

#### 2.1 å¼•å…¥ç»“æ„åŒ–æ—¥å¿— â° 1å¤©

**æ–°å»ºæ–‡ä»¶**: `core/logger.go`

**å®ç°**:
1. å®šä¹‰ Logger æ¥å£
2. å®ç°åŸºäº slog çš„é»˜è®¤å®ç°
3. åœ¨ Spider ä¸­æ³¨å…¥ Logger
4. æ›¿æ¢æ‰€æœ‰ `fmt.Printf` ä¸ºç»“æ„åŒ–æ—¥å¿—

**ç¤ºä¾‹**:
```go
// å‚è€ƒ improvements/02_structured_logging.go
```

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º Logger æ¥å£
- [ ] å®ç° SlogLogger
- [ ] æ›´æ–° Spider æ„é€ å‡½æ•°æ¥å— Logger
- [ ] æ›¿æ¢æ‰€æœ‰æ—¥å¿—è¾“å‡º
- [ ] æ·»åŠ æ—¥å¿—çº§åˆ«é…ç½®

---

#### 2.2 æ·»åŠ é…ç½®éªŒè¯ â° 4å°æ—¶

**æ–‡ä»¶**: `config/config.go`

```go
// æ·»åŠ éªŒè¯æ–¹æ³•
func (c *Config) Validate() error {
    if c.TargetURL == "" {
        return errors.New("ç›®æ ‡URLä¸èƒ½ä¸ºç©º")
    }
    
    if c.DepthSettings.MaxDepth < 0 {
        return errors.New("æœ€å¤§æ·±åº¦ä¸èƒ½ä¸ºè´Ÿæ•°")
    }
    
    if c.DepthSettings.MaxDepth > 10 {
        return errors.New("æœ€å¤§æ·±åº¦ä¸èƒ½è¶…è¿‡10")
    }
    
    if c.AntiDetectionSettings.RequestDelay < 0 {
        return errors.New("è¯·æ±‚å»¶è¿Ÿä¸èƒ½ä¸ºè´Ÿæ•°")
    }
    
    return nil
}

// åœ¨ä¸»ç¨‹åºä¸­è°ƒç”¨
func main() {
    // ...
    if err := cfg.Validate(); err != nil {
        log.Fatalf("é…ç½®éªŒè¯å¤±è´¥: %v", err)
    }
    // ...
}
```

---

#### 2.3 ä¼˜åŒ–å†…å­˜ä½¿ç”¨ â° 1å¤©

**ä¿®æ”¹**:

1. **Result ç»“æ„ä¼˜åŒ–**:
```go
type Result struct {
    URL         string
    StatusCode  int
    ContentType string
    
    // ä¸å†ä¿å­˜å®Œæ•´ HTML
    // HTMLContent string  // âŒ åˆ é™¤
    HTMLDigest  string    // âœ… åªä¿å­˜æ‘˜è¦
    
    Links       []string
    // ...
}
```

2. **æ·»åŠ å†…å­˜é™åˆ¶**:
```go
const MaxHTMLSize = 5 * 1024 * 1024 // 5MB

if len(htmlContent) > MaxHTMLSize {
    // ä¿å­˜åˆ°ç£ç›˜æˆ–ä¸¢å¼ƒ
    slog.Warn("HTMLè¿‡å¤§ï¼Œå·²æˆªæ–­", "url", url, "size", len(htmlContent))
    htmlContent = htmlContent[:MaxHTMLSize]
}
```

3. **ä½¿ç”¨å¯¹è±¡æ± **:
```go
var resultPool = sync.Pool{
    New: func() interface{} {
        return &Result{
            Links: make([]string, 0, 100),
            Forms: make([]Form, 0, 10),
        }
    },
}

func getResult() *Result {
    return resultPool.Get().(*Result)
}

func putResult(r *Result) {
    r.Links = r.Links[:0]
    r.Forms = r.Forms[:0]
    resultPool.Put(r)
}
```

---

#### 2.4 æ·»åŠ ç›‘æ§æŒ‡æ ‡ â° 1å¤©

**æ–°å»ºæ–‡ä»¶**: `core/metrics.go`

```go
// å‚è€ƒ improvements/04_monitoring.go
```

**é›†æˆ**:
```go
type Spider struct {
    // ... ç°æœ‰å­—æ®µ
    metrics *Metrics
}

func (s *Spider) Start(targetURL string) error {
    s.metrics = NewMetrics()
    defer s.printMetrics()
    
    // åœ¨å„ä¸ªæ“ä½œä¸­è®°å½•æŒ‡æ ‡
    s.metrics.IncrementRequests()
    // ...
}

func (s *Spider) printMetrics() {
    snapshot := s.metrics.GetSnapshot()
    snapshot.Print()
}
```

---

## ğŸ“‹ é˜¶æ®µä¸‰ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

### ä¼˜å…ˆçº§ P2 - æŒ‰éœ€å®æ–½

#### 3.1 æ·»åŠ å•å…ƒæµ‹è¯• â° 3å¤©

**ç›®æ ‡è¦†ç›–ç‡**: 60%+

**æµ‹è¯•æ–‡ä»¶ç»“æ„**:
```
core/
  spider_test.go          # Spider æ ¸å¿ƒæµ‹è¯•
  static_crawler_test.go  # é™æ€çˆ¬è™«æµ‹è¯•
  dynamic_crawler_test.go # åŠ¨æ€çˆ¬è™«æµ‹è¯•
  duplicate_handler_test.go
  param_handler_test.go
  ...
```

**æµ‹è¯•ç¤ºä¾‹**:
```go
func TestSpiderBasicCrawl(t *testing.T) {
    // åˆ›å»ºæµ‹è¯•æœåŠ¡å™¨
    ts := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Write([]byte(`<html><a href="/test">Test</a></html>`))
    }))
    defer ts.Close()
    
    // åˆ›å»ºçˆ¬è™«
    cfg := config.NewDefaultConfig()
    cfg.TargetURL = ts.URL
    spider := NewSpider(cfg)
    defer spider.Close()
    
    // æ‰§è¡Œçˆ¬å–
    err := spider.Start(ts.URL)
    assert.NoError(t, err)
    
    // éªŒè¯ç»“æœ
    results := spider.GetResults()
    assert.Greater(t, len(results), 0)
}
```

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¸ºæ ¸å¿ƒç»„ä»¶æ·»åŠ æµ‹è¯•
- [ ] æ·»åŠ é›†æˆæµ‹è¯•
- [ ] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] é…ç½® CI è‡ªåŠ¨è¿è¡Œæµ‹è¯•

---

#### 3.2 æ€§èƒ½ä¼˜åŒ– â° 2å¤©

**ä¼˜åŒ–ç‚¹**:

1. **HTTP å®¢æˆ·ç«¯å¤ç”¨**:
```go
var defaultClient = &http.Client{
    Timeout: 30 * time.Second,
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    },
}
```

2. **Worker Pool å¤ç”¨**:
- å…¨å±€å…±äº« Worker Pool
- é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯

3. **æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘ç¼“å­˜**:
```go
var (
    urlRegex     = regexp.MustCompile(`...`)
    apiRegex     = regexp.MustCompile(`...`)
    // ç¼–è¯‘ä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨
)
```

4. **å­—ç¬¦ä¸²å¤„ç†ä¼˜åŒ–**:
```go
// âŒ é¿å…å¤šæ¬¡æ‹¼æ¥
str := str1 + str2 + str3

// âœ… ä½¿ç”¨ Builder
var builder strings.Builder
builder.WriteString(str1)
builder.WriteString(str2)
builder.WriteString(str3)
str := builder.String()
```

---

#### 3.3 æ·»åŠ é«˜çº§åŠŸèƒ½ â° 1å‘¨

**æ–°åŠŸèƒ½**:

1. **æ–­ç‚¹ç»­çˆ¬**:
```go
type CheckpointManager struct {
    file string
}

func (c *CheckpointManager) Save(state *CrawlState) error {
    // ä¿å­˜çˆ¬å–çŠ¶æ€
}

func (c *CheckpointManager) Load() (*CrawlState, error) {
    // æ¢å¤çˆ¬å–çŠ¶æ€
}
```

2. **åˆ†å¸ƒå¼æ”¯æŒ**:
- Redis é˜Ÿåˆ—
- URL å»é‡å…±äº«
- ç»“æœæ±‡æ€»

3. **æ’ä»¶ç³»ç»Ÿ**:
```go
type Plugin interface {
    Name() string
    OnResult(result *Result) error
}
```

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

### é˜¶æ®µä¸€ï¼šç´§æ€¥ä¿®å¤
- [ ] 1.1 ä¿®å¤èµ„æºæ³„æ¼ â° 4h
- [ ] 1.2 ä¿®å¤ Context ç”Ÿå‘½å‘¨æœŸ â° 2h
- [ ] 1.3 ç»Ÿä¸€é”™è¯¯å¤„ç† â° 3h
- [ ] 1.4 ä¿®å¤å¹¶å‘å®‰å…¨é—®é¢˜ â° 2h

**é¢„è®¡å®Œæˆ**: 2å¤©  
**å½“å‰çŠ¶æ€**: ğŸ”´ æœªå¼€å§‹

---

### é˜¶æ®µäºŒï¼šè´¨é‡æå‡
- [ ] 2.1 å¼•å…¥ç»“æ„åŒ–æ—¥å¿— â° 1å¤©
- [ ] 2.2 æ·»åŠ é…ç½®éªŒè¯ â° 4h
- [ ] 2.3 ä¼˜åŒ–å†…å­˜ä½¿ç”¨ â° 1å¤©
- [ ] 2.4 æ·»åŠ ç›‘æ§æŒ‡æ ‡ â° 1å¤©

**é¢„è®¡å®Œæˆ**: 5å¤©  
**å½“å‰çŠ¶æ€**: ğŸ”´ æœªå¼€å§‹

---

### é˜¶æ®µä¸‰ï¼šé•¿æœŸä¼˜åŒ–
- [ ] 3.1 æ·»åŠ å•å…ƒæµ‹è¯• â° 3å¤©
- [ ] 3.2 æ€§èƒ½ä¼˜åŒ– â° 2å¤©
- [ ] 3.3 æ·»åŠ é«˜çº§åŠŸèƒ½ â° 1å‘¨

**é¢„è®¡å®Œæˆ**: 2å‘¨  
**å½“å‰çŠ¶æ€**: ğŸ”´ æœªå¼€å§‹

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹æŒ‡å—

### ä»Šå¤©å°±å¯ä»¥åšçš„æ”¹è¿›

#### 1. æ·»åŠ  Close æ–¹æ³•ï¼ˆ15åˆ†é’Ÿï¼‰

```go
// core/spider.go
func (s *Spider) Close() error {
    if s.workerPool != nil {
        s.workerPool.Stop()
    }
    return nil
}

// cmd/spider/main.go
func main() {
    // ...
    spider := core.NewSpider(cfg)
    defer spider.Close()  // âœ… ç¡®ä¿æ¸…ç†
    // ...
}
```

#### 2. æ·»åŠ é…ç½®éªŒè¯ï¼ˆ30åˆ†é’Ÿï¼‰

```go
// config/config.go
func (c *Config) Validate() error {
    if c.TargetURL == "" {
        return errors.New("ç›®æ ‡URLä¸èƒ½ä¸ºç©º")
    }
    return nil
}

// cmd/spider/main.go
if err := cfg.Validate(); err != nil {
    log.Fatalf("é…ç½®é”™è¯¯: %v", err)
}
```

#### 3. å®šä¹‰é”™è¯¯å¸¸é‡ï¼ˆ20åˆ†é’Ÿï¼‰

```go
// core/errors.go
package core

import "errors"

var (
    ErrInvalidURL  = errors.New("æ— æ•ˆçš„URL")
    ErrTimeout     = errors.New("è¯·æ±‚è¶…æ—¶")
    ErrRateLimited = errors.New("è¯·æ±‚è¢«é™æµ")
)
```

---

## âœ… éªŒè¯æ¸…å•

### ä»£ç è´¨é‡
- [ ] è¿è¡Œ `go vet ./...` æ— è­¦å‘Š
- [ ] è¿è¡Œ `golangci-lint run` æ— é”™è¯¯
- [ ] è¿è¡Œ `go test -race ./...` æ— ç«æ€
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 60%

### æ€§èƒ½
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®šï¼ˆæ— æ³„æ¼ï¼‰
- [ ] CPU ä½¿ç”¨ç‡åˆç†
- [ ] å“åº”æ—¶é—´åœ¨é¢„æœŸèŒƒå›´
- [ ] å¹¶å‘å¤„ç†æ­£å¸¸

### åŠŸèƒ½
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä¸»è¦åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] è¾¹ç•Œæƒ…å†µå¤„ç†æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„

---

## ğŸ“š å‚è€ƒèµ„æ–™

- Go å®˜æ–¹æ–‡æ¡£: https://go.dev/doc/
- Effective Go: https://go.dev/doc/effective_go
- Go Code Review Comments: https://github.com/golang/go/wiki/CodeReviewComments
- æœ¬é¡¹ç›®æ”¹è¿›ç¤ºä¾‹: `improvements/` ç›®å½•

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ”¹è¿›å»ºè®®è¯·æäº¤åˆ°é¡¹ç›® Issueï¼Œä»£ç æ”¹è¿›è¯·æäº¤ Pull Requestã€‚

---

**æœ€åæ›´æ–°**: 2025-10-24  
**ç»´æŠ¤è€…**: Spider Team

