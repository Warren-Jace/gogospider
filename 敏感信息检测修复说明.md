# 敏感信息检测功能修复说明

## 问题描述

您反映在爬取时没有生成敏感信息文件，即使已经开启了该功能。

## 根本原因分析

经过代码审查，发现了以下问题：

1. **敏感信息检测器无内置规则**  
   在 `core/sensitive_info_detector.go` 中，`initializePatterns()` 方法是空的，所有规则必须从外部JSON文件加载。

2. **规则文件未自动加载**  
   在 `cmd/spider/main.go` 中，只有当用户通过 `-sensitive-rules` 参数明确指定规则文件时，才会加载规则。如果不指定，检测器的规则列表（`patterns`）就是空的，因此无法检测到任何敏感信息。

3. **配置未生效**  
   虽然配置文件中设置了默认规则文件路径 `./sensitive_rules_config.json`，但这个配置值从未被实际使用。

## 修复内容

### 修改的文件
- `cmd/spider/main.go` (2处修改)

### 修复逻辑

1. **主程序启动时**（第553-575行）：
   - 当敏感信息检测开启时，如果用户没有指定规则文件，自动使用配置中的默认规则文件
   - 如果加载成功，显示 ✅ 提示
   - 如果加载失败，显示 ⚠️ 警告和建议

2. **批量扫描模式**（第1324-1336行）：
   - 应用相同的逻辑，确保批量扫描时也能加载规则

## 如何使用（修复后）

### 方法1：使用默认规则文件（推荐）

确保项目根目录下有规则文件，运行爬虫即可：

```bash
# 使用默认配置文件中指定的规则（./sensitive_rules_config.json）
spider.exe -url https://example.com

# 程序会自动加载并显示：
# ✅ 已加载敏感信息规则文件: ./sensitive_rules_config.json
```

### 方法2：明确指定规则文件

```bash
# 使用标准规则文件（推荐，40个规则）
spider.exe -url https://example.com -sensitive-rules sensitive_rules_standard.json

# 使用完整规则文件（70+个规则）
spider.exe -url https://example.com -sensitive-rules sensitive_rules_config.json

# 使用精简规则文件（快速扫描，10个规则）
spider.exe -url https://example.com -sensitive-rules sensitive_rules_minimal.json
```

### 方法3：禁用敏感信息检测

如果不需要此功能，可以明确禁用：

```bash
spider.exe -url https://example.com -sensitive-detect=false
```

## 可用的规则文件

项目提供了3个预设规则文件：

| 文件名 | 规则数量 | 适用场景 | 说明 |
|--------|---------|---------|------|
| `sensitive_rules_minimal.json` | 10个 | 快速扫描 | 只检测最高危的泄露（云存储密钥、数据库密码等） |
| `sensitive_rules_standard.json` | 40个 | 日常使用（推荐） | 平衡检测效果和性能 |
| `sensitive_rules_config.json` | 70+个 | 全面审计 | 最全面的检测规则（包括个人信息） |

## 输出文件说明

开启敏感信息检测后，会生成以下文件：

```
spider_example.com_20250126_143022_sensitive.txt     # 文本格式报告
spider_example.com_20250126_143022_sensitive.json    # JSON格式报告
```

### 文本报告格式示例

```
==========================================
   敏感信息泄露检测报告
==========================================

扫描页面数: 25
发现总数: 8
  - 高危: 2
  - 中危: 3
  - 低危: 3

==========================================

【高危发现】
------------------------------------------------------------

[1] AWS S3 Access Key
    来源URL: https://example.com/config.js
    位置: Line 42
    值: AKIA****************

[2] 数据库密码
    来源URL: https://example.com/admin/debug
    位置: Line 15
    值: root****
```

### JSON报告格式示例

```json
{
  "scan_time": "2025-01-26 14:30:22",
  "target_domain": "example.com",
  "statistics": {
    "total_scanned": 25,
    "total_findings": 8,
    "high_severity": 2,
    "medium_severity": 3,
    "low_severity": 3
  },
  "findings": [
    {
      "type": "AWS S3 Access Key",
      "value": "AKIA****************",
      "location": "Line 42",
      "severity": "HIGH",
      "source_url": "https://example.com/config.js",
      "line_number": 42
    }
  ]
}
```

## 验证修复

运行以下命令测试修复是否成功：

```bash
# 1. 测试自动加载默认规则
spider.exe -url https://example.com

# 应该看到输出：
# ✅ 已加载敏感信息规则文件: ./sensitive_rules_config.json

# 2. 测试明确指定规则
spider.exe -url https://example.com -sensitive-rules sensitive_rules_standard.json

# 应该看到输出：
# ✅ 已加载敏感信息规则文件: sensitive_rules_standard.json

# 3. 测试规则文件不存在的情况
spider.exe -url https://example.com -sensitive-rules not_exist.json

# 应该看到警告：
# ⚠️  警告: 加载敏感规则失败: 读取规则文件失败: open not_exist.json: The system cannot find the file specified.
# 💡 提示: 请使用 -sensitive-rules 参数指定规则文件，或确保默认文件存在
#     推荐: -sensitive-rules sensitive_rules_standard.json
```

## 常见问题

### Q1: 为什么我的敏感信息没有被检测到？

**A:** 可能的原因：

1. **规则文件未加载**（已修复）：检查启动时是否有 ✅ 加载成功的提示
2. **最低严重级别设置过高**：如果设置了 `-sensitive-min-severity HIGH`，则只显示高危发现
3. **规则不匹配**：检查您的敏感信息格式是否符合规则的正则表达式

### Q2: 如何自定义敏感信息检测规则？

**A:** 复制并修改现有规则文件：

1. 复制 `sensitive_rules_standard.json` 为 `my_rules.json`
2. 编辑文件，添加或修改规则
3. 使用 `-sensitive-rules my_rules.json` 加载

规则格式：
```json
{
  "rules": {
    "我的自定义规则": {
      "pattern": "正则表达式",
      "severity": "HIGH|MEDIUM|LOW",
      "mask": true,
      "description": "规则说明"
    }
  }
}
```

### Q3: 扫描速度是否会受影响？

**A:** 
- 使用 `sensitive_rules_minimal.json`（10规则）：几乎无影响
- 使用 `sensitive_rules_standard.json`（40规则）：轻微影响（推荐）
- 使用 `sensitive_rules_config.json`（70+规则）：有一定影响

### Q4: 敏感信息会被完整记录吗？

**A:** 
- **默认情况**：敏感信息会被脱敏（如 `AKIA****************`）
- 如果需要完整值（用于测试），使用配置文件设置 `SaveFullValue: true`

## 技术细节

### 修复前的执行流程

```
1. 用户启动：spider.exe -url https://example.com
2. 创建爬虫实例（NewSpider）
   └─ 创建敏感信息检测器（NewSensitiveInfoDetector）
      └─ initializePatterns() → 什么都不做（规则为空）
3. 检查是否指定了 -sensitive-rules 参数 → 没有 → 跳过加载
4. 开始爬取
5. 每个页面都会调用敏感信息扫描
   └─ 但由于 patterns 为空，永远不会匹配到任何敏感信息
6. 结果：敏感信息文件为空或不生成
```

### 修复后的执行流程

```
1. 用户启动：spider.exe -url https://example.com
2. 创建爬虫实例（NewSpider）
   └─ 创建敏感信息检测器（NewSensitiveInfoDetector）
      └─ initializePatterns() → 等待外部规则加载
3. 检查敏感信息检测是否启用 → 是
   ├─ 检查是否指定了 -sensitive-rules → 没有
   └─ 使用配置默认规则文件 → ./sensitive_rules_config.json
4. 加载规则文件 → MergeSensitiveRules()
   └─ 成功加载70+条规则 ✅
5. 开始爬取
6. 每个页面都会调用敏感信息扫描
   └─ 使用已加载的规则进行匹配
7. 发现敏感信息 → 记录并输出到文件
8. 结果：生成完整的敏感信息报告
```

## 其他相关参数

```bash
-sensitive-detect=true/false       # 启用/禁用敏感信息检测（默认true）
-sensitive-rules string            # 指定规则文件路径
-sensitive-min-severity string     # 最低严重级别：LOW/MEDIUM/HIGH（默认LOW）
-sensitive-scan-body=true/false    # 扫描响应体（默认true）
-sensitive-scan-headers=true/false # 扫描响应头（默认true）
-sensitive-realtime=true/false     # 实时输出发现（默认true）
-sensitive-output string           # 指定敏感信息输出文件路径
```

## 完整示例

```bash
# 完整配置示例
spider.exe \
  -url https://example.com \
  -depth 5 \
  -max-pages 1000 \
  -sensitive-rules sensitive_rules_standard.json \
  -sensitive-min-severity MEDIUM \
  -output ./results/
```

## 更新日志

- **2025-01-26**: 修复敏感信息检测规则未自动加载的问题
  - 当用户未指定规则文件时，自动加载配置中的默认规则文件
  - 增加了明确的加载成功/失败提示
  - 同时修复了批量扫描模式的相同问题

---

如有其他问题，请参考：
- 参数指南: `PARAMETERS_GUIDE.md`
- 配置FAQ: `CONFIGURATION_FAQ.md`
- GitHub Issues: https://github.com/Warren-Jace/gogospider/issues

