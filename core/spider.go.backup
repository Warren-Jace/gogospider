package core

import (
	"encoding/json"
	"fmt"
	"io"
	"log"
	"log/slog"
	"net/http"
	"net/url"
	"os"
	"sort"
	"strings"
	"sync"
	"time"

	"spider-golang/config"
)

// Spider ä¸»çˆ¬è™«åè°ƒå™¨
type Spider struct {
	config              *config.Config
	staticCrawler       StaticCrawler
	dynamicCrawler      DynamicCrawler
	jsAnalyzer          *JSAnalyzer
	paramHandler        *ParamHandler
	duplicateHandler    *DuplicateHandler
	smartDeduplication  *SmartDeduplication
	smartParamDedup     *SmartParamDeduplicator // æ™ºèƒ½å‚æ•°å€¼å»é‡å™¨ï¼ˆv2.6.1ï¼‰
	businessFilter      *BusinessAwareURLFilter  // ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤å™¨ï¼ˆv2.7ï¼‰
	urlPatternDedup     *URLPatternDeduplicator  // URLæ¨¡å¼å»é‡å™¨ï¼ˆv2.9ï¼‰
	hiddenPathDiscovery *HiddenPathDiscovery
	cdnDetector         *CDNDetector // CDNæ£€æµ‹å™¨
	workerPool          *WorkerPool  // å¹¶å‘å·¥ä½œæ± 

	// æ–°å¢ä¼˜åŒ–ç»„ä»¶
	formFiller       *SmartFormFiller      // æ™ºèƒ½è¡¨å•å¡«å……å™¨
	advancedScope    *AdvancedScope        // é«˜çº§ä½œç”¨åŸŸæ§åˆ¶
	scopeController  *ScopeController      // ä½œç”¨åŸŸæ§åˆ¶å™¨ï¼ˆv3.1ï¼‰
	perfOptimizer    *PerformanceOptimizer // æ€§èƒ½ä¼˜åŒ–å™¨

	// é«˜çº§åŠŸèƒ½ç»„ä»¶
	techDetector       *TechStackDetector     // æŠ€æœ¯æ ˆæ£€æµ‹å™¨
	sensitiveDetector  *SensitiveInfoDetector // æ•æ„Ÿä¿¡æ¯æ£€æµ‹å™¨
	passiveCrawler     *PassiveCrawler        // è¢«åŠ¨çˆ¬å–å™¨
	subdomainExtractor *SubdomainExtractor    // å­åŸŸåæå–å™¨
	domSimilarity      *DOMSimilarityDetector // DOMç›¸ä¼¼åº¦æ£€æµ‹å™¨
	sitemapCrawler     *SitemapCrawler        // Sitemapçˆ¬å–å™¨
	assetClassifier    *AssetClassifier       // é™æ€èµ„æºåˆ†ç±»å™¨
	ipDetector         *IPDetector            // IPåœ°å€æ£€æµ‹å™¨
	
	// ğŸ†• v2.7+ æ–°å¢ç»„ä»¶
	cssAnalyzer         *CSSAnalyzer            // CSSåˆ†æå™¨
	resourceClassifier  *ResourceClassifier     // èµ„æºåˆ†ç±»å™¨
	urlDeduplicator     *URLDeduplicator        // URLå»é‡å™¨ï¼ˆå¿½ç•¥å‚æ•°å€¼ï¼‰
	urlStructureDedup   *URLStructureDeduplicator // URLç»“æ„åŒ–å»é‡å™¨ï¼ˆè·¯å¾„å˜é‡+å‚æ•°ï¼‰
	priorityScheduler   *URLPriorityScheduler   // ä¼˜å…ˆçº§è°ƒåº¦å™¨ï¼ˆå¯é€‰ï¼‰
	
	// ğŸ†• v3.2 æ–°å¢ç»„ä»¶
	cookieManager      *CookieManager      // Cookieç®¡ç†å™¨
	loginWallDetector  *LoginWallDetector  // ç™»å½•å¢™æ£€æµ‹å™¨
	redirectManager    *RedirectManager    // é‡å®šå‘ç®¡ç†å™¨
	
	// ğŸ†• v3.4 æ–°å¢ç»„ä»¶
	adaptiveLearner    *AdaptivePriorityLearner // è‡ªé€‚åº”ä¼˜å…ˆçº§å­¦ä¹ å™¨
	
	// ğŸ†• v3.5 æ–°å¢ç»„ä»¶ - URLè´¨é‡æ§åˆ¶
	urlValidator       *URLValidator            // URLéªŒè¯å™¨ï¼ˆè¿‡æ»¤æ— æ•ˆURLï¼‰
	postDetector       *POSTRequestDetector     // POSTè¯·æ±‚æ£€æµ‹å™¨ï¼ˆå¢å¼ºPOSTæ£€æµ‹ï¼‰

	results           []*Result
	sitemapURLs       []string         // ä»sitemapå‘ç°çš„URL
	robotsURLs        []string         // ä»robots.txtå‘ç°çš„URL
	externalLinks     []string         // è®°å½•å¤–éƒ¨é“¾æ¥
	hiddenPaths       []string         // è®°å½•éšè—è·¯å¾„
	securityFindings  []string         // è®°å½•å®‰å…¨å‘ç°
	crossDomainJS     []string         // è®°å½•è·¨åŸŸJSå‘ç°çš„URL
	detectedTechs     []*TechInfo      // æ£€æµ‹åˆ°çš„æŠ€æœ¯æ ˆ
	sensitiveFindings []*SensitiveInfo // æ•æ„Ÿä¿¡æ¯å‘ç°
	mutex             sync.Mutex
	targetDomain      string          // ç›®æ ‡åŸŸå
	visitedURLs       map[string]bool // å·²è®¿é—®URL

	// èµ„æºç®¡ç†ï¼ˆä¼˜åŒ–ï¼šé˜²æ­¢æ³„æ¼ï¼‰
	done     chan struct{}  // å®Œæˆä¿¡å·
	wg       sync.WaitGroup // ç­‰å¾…æ‰€æœ‰goroutineå®Œæˆ
	closed   bool           // æ˜¯å¦å·²å…³é—­
	closeMux sync.Mutex     // å…³é—­é”

	// v2.6: æ—¥å¿—å’Œç›‘æ§
	logger Logger // ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨
}

// NewSpider åˆ›å»ºçˆ¬è™«å®ä¾‹
func NewSpider(cfg *config.Config) *Spider {
	// v2.6: åˆ›å»ºæ—¥å¿—è®°å½•å™¨
	var logOutput io.Writer = os.Stdout
	if cfg.LogSettings.OutputFile != "" {
		file, err := os.OpenFile(cfg.LogSettings.OutputFile,
			os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644)
		if err != nil {
			log.Printf("æ— æ³•æ‰“å¼€æ—¥å¿—æ–‡ä»¶ %s: %vï¼Œä½¿ç”¨æ ‡å‡†è¾“å‡º", cfg.LogSettings.OutputFile, err)
		} else {
			logOutput = file
		}
	}

	logLevel := parseLogLevel(cfg.LogSettings.Level)
	logger := NewLogger(logLevel, logOutput)

	// åˆ›å»ºç»“æœé€šé“å’Œåœæ­¢é€šé“
	resultChan := make(chan Result, 100)
	stopChan := make(chan struct{})

	// è®¡ç®—å¹¶å‘workeræ•°é‡ï¼ˆé»˜è®¤20ä¸ªï¼Œå¯é…ç½®ï¼‰
	workerCount := 20
	if cfg.DepthSettings.MaxDepth > 2 {
		workerCount = 30 // æ·±åº¦çˆ¬å–æ—¶å¢åŠ workeræ•°
	}

	// é€Ÿç‡é™åˆ¶ï¼ˆæ¯ç§’æœ€å¤š20ä¸ªè¯·æ±‚ï¼Œé¿å…è¿‡è½½ï¼‰
	maxQPS := 20

	spider := &Spider{
		config:             cfg,
		staticCrawler:      NewStaticCrawler(cfg, resultChan, stopChan),
		dynamicCrawler:     NewDynamicCrawler(),
		jsAnalyzer:         NewJSAnalyzer(),
		paramHandler:       NewParamHandler(),
		duplicateHandler:   NewDuplicateHandler(cfg.DeduplicationSettings.SimilarityThreshold),
		smartDeduplication: NewSmartDeduplication(),                                                                                                             // åˆå§‹åŒ–æ™ºèƒ½å»é‡
		smartParamDedup:    NewSmartParamDeduplicator(cfg.DeduplicationSettings.MaxParamValueVariantsPerGroup, cfg.DeduplicationSettings.EnableSmartParamDedup), // v2.6.1: æ™ºèƒ½å‚æ•°å€¼å»é‡
		businessFilter:     NewBusinessAwareURLFilter(BusinessFilterConfig{                                                                                       // v2.7: ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤å™¨
			MinBusinessScore:        cfg.DeduplicationSettings.BusinessFilterMinScore,
			HighValueThreshold:      cfg.DeduplicationSettings.BusinessFilterHighValueThreshold,
			MaxSamePatternLowValue:  cfg.DeduplicationSettings.BusinessFilterMaxLowValue,
			MaxSamePatternMidValue:  cfg.DeduplicationSettings.BusinessFilterMaxMidValue,
			MaxSamePatternHighValue: cfg.DeduplicationSettings.BusinessFilterMaxHighValue,
			EnableAdaptiveLearning:  cfg.DeduplicationSettings.BusinessFilterAdaptiveLearning,
			Enabled:                 cfg.DeduplicationSettings.EnableBusinessAwareFilter,
		}),
		urlPatternDedup: NewURLPatternDeduplicator(), // v2.9: URLæ¨¡å¼å»é‡å™¨
		cdnDetector:     NewCDNDetector(),            // åˆå§‹åŒ–CDNæ£€æµ‹å™¨
		workerPool:      NewWorkerPool(workerCount, maxQPS), // åˆå§‹åŒ–å·¥ä½œæ± 

		// åˆå§‹åŒ–æ–°å¢ç»„ä»¶
		formFiller:      NewSmartFormFiller(),         // æ™ºèƒ½è¡¨å•å¡«å……å™¨
		advancedScope:   nil,                          // å°†åœ¨Startä¸­åˆå§‹åŒ–
		scopeController: nil,                          // å°†åœ¨Startä¸­åˆå§‹åŒ–ï¼ˆv3.1ï¼‰
		perfOptimizer:   NewPerformanceOptimizer(500), // æ€§èƒ½ä¼˜åŒ–å™¨ï¼ˆé™åˆ¶500MBï¼‰

		// åˆå§‹åŒ–é«˜çº§åŠŸèƒ½ç»„ä»¶
		techDetector:      NewTechStackDetector(),         // æŠ€æœ¯æ ˆæ£€æµ‹å™¨
		sensitiveDetector: NewSensitiveInfoDetector(),     // æ•æ„Ÿä¿¡æ¯æ£€æµ‹å™¨
		
		// ğŸ†• v3.5: åˆå§‹åŒ–URLè´¨é‡æ§åˆ¶ç»„ä»¶
		urlValidator:      NewURLValidator(),              // URLéªŒè¯å™¨
		postDetector:      NewPOSTRequestDetector(),       // POSTè¯·æ±‚æ£€æµ‹å™¨
		passiveCrawler:    nil,                            // æŒ‰éœ€åˆ›å»º
		domSimilarity:     NewDOMSimilarityDetector(0.85), // DOMç›¸ä¼¼åº¦æ£€æµ‹å™¨ï¼ˆé˜ˆå€¼85%ï¼‰
		sitemapCrawler:    NewSitemapCrawler(),            // Sitemapçˆ¬å–å™¨
		assetClassifier:   NewAssetClassifier(),           // é™æ€èµ„æºåˆ†ç±»å™¨
		ipDetector:        NewIPDetector(),                // IPåœ°å€æ£€æµ‹å™¨
		
		// ğŸ†• v2.7+ æ–°å¢ç»„ä»¶
		cssAnalyzer:        NewCSSAnalyzer(),              // CSSåˆ†æå™¨
		resourceClassifier: nil,                           // å°†åœ¨Startä¸­åˆå§‹åŒ–ï¼ˆéœ€è¦ç›®æ ‡åŸŸåï¼‰
		urlDeduplicator:    NewURLDeduplicator(),         // URLå»é‡å™¨
		urlStructureDedup:  NewURLStructureDeduplicator(), // URLç»“æ„åŒ–å»é‡å™¨
		priorityScheduler:  nil,                           // å°†åœ¨Startä¸­åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½®ï¼‰
		
		// ğŸ†• v3.2 æ–°å¢ç»„ä»¶
		cookieManager:     NewCookieManager(),      // Cookieç®¡ç†å™¨
		loginWallDetector: NewLoginWallDetector(),  // ç™»å½•å¢™æ£€æµ‹å™¨
		redirectManager:   NewRedirectManager(),    // é‡å®šå‘ç®¡ç†å™¨
		
		// ğŸ†• v3.4 æ–°å¢ç»„ä»¶
		adaptiveLearner:   nil,                     // å°†åœ¨Startä¸­åˆå§‹åŒ–ï¼ˆå¦‚æœå¯ç”¨ï¼‰

		hiddenPathDiscovery: nil, // å°†åœ¨Startæ–¹æ³•ä¸­åˆå§‹åŒ–ï¼Œéœ€è¦ç”¨æˆ·ä»£ç†
		results:             make([]*Result, 0),
		externalLinks:       make([]string, 0),
		hiddenPaths:         make([]string, 0),
		securityFindings:    make([]string, 0),
		crossDomainJS:       make([]string, 0),
		detectedTechs:       make([]*TechInfo, 0),
		sensitiveFindings:   make([]*SensitiveInfo, 0),
		sitemapURLs:         make([]string, 0),
		robotsURLs:          make([]string, 0),
		visitedURLs:         make(map[string]bool),

		// åˆå§‹åŒ–èµ„æºç®¡ç†
		done:   make(chan struct{}),
		closed: false,

		// v2.6: åˆå§‹åŒ–æ—¥å¿—
		logger: logger,
	}

	// é…ç½®å„ä¸ªç»„ä»¶
	spider.staticCrawler.Configure(cfg)
	spider.dynamicCrawler.Configure(cfg)

	// è®¾ç½®JSåˆ†æå™¨çš„ç›®æ ‡åŸŸå
	spider.jsAnalyzer.SetTargetDomain(cfg.TargetURL)
	
	// ğŸ†• v3.2: å°†Cookieç®¡ç†å™¨å’Œé‡å®šå‘ç®¡ç†å™¨ä¼ é€’ç»™é™æ€çˆ¬è™«
	if staticCrawlerImpl, ok := spider.staticCrawler.(*StaticCrawlerImpl); ok {
		staticCrawlerImpl.SetCookieManager(spider.cookieManager)
		staticCrawlerImpl.SetRedirectManager(spider.redirectManager)
	}

	return spider
}

// parseLogLevel è§£ææ—¥å¿—çº§åˆ«å­—ç¬¦ä¸²ä¸º slog.Level
func parseLogLevel(level string) slog.Level {
	switch strings.ToUpper(level) {
	case "DEBUG":
		return slog.LevelDebug
	case "INFO":
		return slog.LevelInfo
	case "WARN", "WARNING":
		return slog.LevelWarn
	case "ERROR":
		return slog.LevelError
	default:
		return slog.LevelInfo
	}
}

// LoadSensitiveRules åŠ è½½å¤–éƒ¨æ•æ„Ÿä¿¡æ¯è§„åˆ™æ–‡ä»¶
func (s *Spider) LoadSensitiveRules(filename string) error {
	if s.sensitiveDetector == nil {
		return fmt.Errorf("æ•æ„Ÿä¿¡æ¯æ£€æµ‹å™¨æœªåˆå§‹åŒ–")
	}
	return s.sensitiveDetector.LoadRulesFromFile(filename)
}

// MergeSensitiveRules åˆå¹¶å¤–éƒ¨æ•æ„Ÿä¿¡æ¯è§„åˆ™æ–‡ä»¶ï¼ˆä¸æ¸…ç©ºç°æœ‰è§„åˆ™ï¼‰
func (s *Spider) MergeSensitiveRules(filename string) error {
	if s.sensitiveDetector == nil {
		return fmt.Errorf("æ•æ„Ÿä¿¡æ¯æ£€æµ‹å™¨æœªåˆå§‹åŒ–")
	}
	return s.sensitiveDetector.MergeRulesFromFile(filename)
}

// LoadCookieFromFile ä»æ–‡ä»¶åŠ è½½Cookie
func (s *Spider) LoadCookieFromFile(filename string) error {
	if s.cookieManager == nil {
		return fmt.Errorf("Cookieç®¡ç†å™¨æœªåˆå§‹åŒ–")
	}
	return s.cookieManager.LoadFromFile(filename)
}

// LoadCookieFromString ä»å­—ç¬¦ä¸²åŠ è½½Cookie
func (s *Spider) LoadCookieFromString(cookieString string) error {
	if s.cookieManager == nil {
		return fmt.Errorf("Cookieç®¡ç†å™¨æœªåˆå§‹åŒ–")
	}
	return s.cookieManager.LoadFromString(cookieString)
}

// GetCookieManager è·å–Cookieç®¡ç†å™¨
func (s *Spider) GetCookieManager() *CookieManager {
	return s.cookieManager
}

// Start å¼€å§‹çˆ¬å–
func (s *Spider) Start(targetURL string) error {
	// ç¡®ä¿èµ„æºæ¸…ç†ï¼ˆä¼˜åŒ–ï¼šé˜²æ­¢æ³„æ¼ï¼‰
	defer s.cleanup()

	// è§£æç›®æ ‡URLå¹¶æå–åŸŸå
	parsedURL, err := url.Parse(targetURL)
	if err != nil {
		return fmt.Errorf("æ— æ•ˆçš„URL: %v", err)
	}
	s.targetDomain = parsedURL.Host

	// è®¾ç½®JSåˆ†æå™¨çš„ç›®æ ‡åŸŸå
	s.jsAnalyzer.SetTargetDomain(s.targetDomain)
	
	// è®¾ç½®CSSåˆ†æå™¨çš„ç›®æ ‡åŸŸå
	s.cssAnalyzer.SetTargetDomain(s.targetDomain)
	
	// åˆå§‹åŒ–èµ„æºåˆ†ç±»å™¨
	s.resourceClassifier = NewResourceClassifier(s.targetDomain)
	
	// ğŸ†• åˆå§‹åŒ–ä¼˜å…ˆçº§è°ƒåº¦å™¨ï¼ˆå¦‚æœé…ç½®å¯ç”¨ï¼‰
	// å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶æ˜¯å¦ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—æ¨¡å¼
	s.priorityScheduler = NewURLPriorityScheduler(s.targetDomain)

	// åˆå§‹åŒ–é«˜çº§ä½œç”¨åŸŸæ§åˆ¶
	s.advancedScope = NewAdvancedScope(s.targetDomain)
	s.advancedScope.SetMode(ScopeRDN)         // æ ¹åŸŸåæ¨¡å¼
	s.advancedScope.PresetStaticFilterScope() // è¿‡æ»¤é™æ€èµ„æº
	
	// ğŸ†• v3.1: åˆå§‹åŒ–ä½œç”¨åŸŸæ§åˆ¶å™¨
	scopeConfig := ScopeConfig{
		IncludeDomains:    s.config.ScopeSettings.IncludeDomains,
		ExcludeDomains:    s.config.ScopeSettings.ExcludeDomains,
		IncludePaths:      s.config.ScopeSettings.IncludePaths,
		ExcludePaths:      s.config.ScopeSettings.ExcludePaths,
		IncludeRegex:      s.config.ScopeSettings.IncludeRegex,
		ExcludeRegex:      s.config.ScopeSettings.ExcludeRegex,
		IncludeExtensions: s.config.ScopeSettings.IncludeExtensions,
		ExcludeExtensions: s.config.ScopeSettings.ExcludeExtensions,
		IncludeParams:     []string{}, // æš‚ä¸æ”¯æŒå‚æ•°è¿‡æ»¤
		ExcludeParams:     []string{}, // æš‚ä¸æ”¯æŒå‚æ•°è¿‡æ»¤
		MaxDepth:          s.config.DepthSettings.MaxDepth,
		AllowSubdomains:   s.config.ScopeSettings.AllowSubdomains,
		StayInDomain:      s.config.ScopeSettings.StayInDomain,
		AllowHTTP:         s.config.ScopeSettings.AllowHTTP,
		AllowHTTPS:        s.config.ScopeSettings.AllowHTTPS,
	}
	s.scopeController, err = NewScopeController(scopeConfig)
	if err != nil {
		return fmt.Errorf("åˆå§‹åŒ–ä½œç”¨åŸŸæ§åˆ¶å™¨å¤±è´¥: %v", err)
	}

	// åˆå§‹åŒ–å­åŸŸåæå–å™¨
	s.subdomainExtractor = NewSubdomainExtractor(targetURL)

	// æ£€æŸ¥æ˜¯å¦é‡å¤
	if s.duplicateHandler.IsDuplicateURL(targetURL) {
		return fmt.Errorf("URLå·²å¤„ç†è¿‡: %s", targetURL)
	}

	// v2.6: ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
	s.logger.Info("å¼€å§‹çˆ¬å–",
		"url", targetURL,
		"target_domain", s.targetDomain,
		"max_depth", s.config.DepthSettings.MaxDepth,
		"version", "v2.6")

	// æ˜¾ç¤ºåŠŸèƒ½æ¸…å•ï¼ˆä¿ç•™ç”¨æˆ·å‹å¥½çš„æ ¼å¼ï¼‰
	fmt.Printf("\nã€å·²å¯ç”¨åŠŸèƒ½ã€‘Spider Ultimate v2.6\n")
	fmt.Printf("  âœ“ è·¨åŸŸJSåˆ†æï¼ˆæ”¯æŒ60+ä¸ªCDNï¼‰\n")
	fmt.Printf("  âœ“ æ™ºèƒ½è¡¨å•å¡«å……ï¼ˆæ”¯æŒ20+ç§å­—æ®µç±»å‹ï¼‰\n")
	fmt.Printf("  âœ“ ä½œç”¨åŸŸç²¾ç¡®æ§åˆ¶ï¼ˆ10ä¸ªè¿‡æ»¤ç»´åº¦ï¼‰\n")
	fmt.Printf("  âœ“ æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯¹è±¡æ± +è¿æ¥æ± ï¼‰\n")
	fmt.Printf("  âœ“ æŠ€æœ¯æ ˆè¯†åˆ«ï¼ˆ15+ç§æ¡†æ¶ï¼‰\n")
	fmt.Printf("  âœ“ æ•æ„Ÿä¿¡æ¯æ£€æµ‹ï¼ˆ30+ç§æ¨¡å¼ï¼‰\n")
	fmt.Printf("  âœ“ JavaScriptäº‹ä»¶è§¦å‘ï¼ˆç‚¹å‡»ã€æ‚¬åœã€è¾“å…¥ã€æ»šåŠ¨ï¼‰\n")
	fmt.Printf("  âœ“ AJAXè¯·æ±‚æ‹¦æˆªï¼ˆåŠ¨æ€URLæ•è·ï¼‰\n")
	fmt.Printf("  âœ“ å¢å¼ºJSåˆ†æï¼ˆå¯¹è±¡ã€è·¯ç”±ã€é…ç½®ï¼‰\n")
	fmt.Printf("  âœ“ é™æ€èµ„æºåˆ†ç±»ï¼ˆ7ç§ç±»å‹ï¼‰\n")
	fmt.Printf("  âœ“ IPåœ°å€æ£€æµ‹ï¼ˆå†…ç½‘æ³„éœ²è¯†åˆ«ï¼‰\n")
	fmt.Printf("  âœ“ URLä¼˜å…ˆçº§æ’åºï¼ˆæ™ºèƒ½çˆ¬å–ç­–ç•¥ï¼‰\n")
	fmt.Printf("  âœ“ ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿï¼ˆåˆ†çº§ã€æ–‡ä»¶ã€JSONï¼‰ğŸ†•\n")
	fmt.Printf("\nçˆ¬å–é…ç½®:\n")
	fmt.Printf("  æ·±åº¦: %d å±‚ | å¹¶å‘: 20-30 | æ—¥å¿—: %s\n",
		s.config.DepthSettings.MaxDepth, s.config.LogSettings.Level)
	fmt.Printf("\n")

	// åˆå§‹åŒ–éšè—è·¯å¾„å‘ç°å™¨
	userAgent := ""
	if len(s.config.AntiDetectionSettings.UserAgents) > 0 {
		userAgent = s.config.AntiDetectionSettings.UserAgents[0]
	}
	s.hiddenPathDiscovery = NewHiddenPathDiscovery(targetURL, userAgent)

	// === ä¼˜åŒ–ï¼šå…ˆçˆ¬å–sitemap.xmlå’Œrobots.txt ===
	s.logger.Info("å¼€å§‹çˆ¬å–sitemapå’Œrobots.txt", "target", targetURL)
	sitemapURLs, robotsInfo := s.sitemapCrawler.GetAllURLs(targetURL)
	s.mutex.Lock()
	s.sitemapURLs = sitemapURLs
	s.robotsURLs = append(robotsInfo.DisallowPaths, robotsInfo.AllowPaths...)
	s.mutex.Unlock()

	s.logger.Info("sitemapå’Œrobots.txtçˆ¬å–å®Œæˆ",
		"sitemap_urls", len(sitemapURLs),
		"disallow_paths", len(robotsInfo.DisallowPaths),
		"allow_paths", len(robotsInfo.AllowPaths),
		"extra_sitemaps", len(robotsInfo.SitemapURLs))

	// å°†sitemapå’Œrobotsä¸­çš„URLæ·»åŠ åˆ°å¾…çˆ¬å–åˆ—è¡¨
	for _, u := range sitemapURLs {
		s.visitedURLs[u] = false // æ ‡è®°ä¸ºå¾…çˆ¬å–
	}
	for _, u := range robotsInfo.DisallowPaths {
		s.visitedURLs[u] = false // Disallowè·¯å¾„ä¹Ÿè¦çˆ¬å–
	}

	// å¼€å§‹éšè—è·¯å¾„å‘ç°ï¼ˆå¯é€‰ï¼‰
	if s.config.StrategySettings.EnableCommonPathScan {
		s.logger.Info("å¼€å§‹æ‰«æéšè—è·¯å¾„")
		hiddenPaths := s.hiddenPathDiscovery.DiscoverAllHiddenPaths()
		s.mutex.Lock()
		s.hiddenPaths = append(s.hiddenPaths, hiddenPaths...)
		s.mutex.Unlock()
		s.logger.Info("éšè—è·¯å¾„æ‰«æå®Œæˆ", "count", len(hiddenPaths))
	} else {
		s.logger.Info("è·³è¿‡éšè—è·¯å¾„æ‰«æï¼ˆEnableCommonPathScan=falseï¼‰")
	}

	// æ ¹æ®é…ç½®å†³å®šä½¿ç”¨å“ªç§çˆ¬è™«ç­–ç•¥
	if s.config.StrategySettings.EnableStaticCrawler {
		s.logger.Info("ä½¿ç”¨é™æ€çˆ¬è™«", "url", targetURL)
		result, err := s.staticCrawler.Crawl(parsedURL)
		if err != nil {
			s.logger.Error("é™æ€çˆ¬è™«å¤±è´¥", "url", targetURL, "error", err)
		} else {
			s.addResult(result)
			s.logger.Info("é™æ€çˆ¬è™«å®Œæˆ",
				"url", targetURL,
				"links", len(result.Links),
				"assets", len(result.Assets),
				"forms", len(result.Forms),
				"apis", len(result.APIs))
		}
	}

	// å¦‚æœå¯ç”¨äº†åŠ¨æ€çˆ¬è™«ï¼Œæ€»æ˜¯ä½¿ç”¨ï¼ˆPhase 2/3ä¼˜åŒ–ï¼šæ•è·AJAXå’ŒJSåŠ¨æ€å†…å®¹ï¼‰
	if s.config.StrategySettings.EnableDynamicCrawler {
		s.logger.Info("ä½¿ç”¨åŠ¨æ€çˆ¬è™«", "url", targetURL, "mode", "ajax_intercept")
		result, err := s.dynamicCrawler.Crawl(parsedURL)
		if err != nil {
			s.logger.Error("åŠ¨æ€çˆ¬è™«å¤±è´¥", "url", targetURL, "error", err)
		} else {
			s.addResult(result)
			s.logger.Info("åŠ¨æ€çˆ¬è™«å®Œæˆ",
				"url", targetURL,
				"links", len(result.Links),
				"assets", len(result.Assets),
				"forms", len(result.Forms),
				"apis", len(result.APIs))
		}
	}

	// å‚æ•°çˆ†ç ´åŠŸèƒ½å·²ç§»é™¤ï¼Œä¸“æ³¨äºçº¯çˆ¬è™«
	// ä¸å†ç”Ÿæˆå‚æ•°çˆ†ç ´URLï¼Œåªçˆ¬å–çœŸå®å‘ç°çš„é“¾æ¥

	// åˆ†æè·¨åŸŸJSæ–‡ä»¶ï¼ˆåœ¨é€’å½’çˆ¬å–ä¹‹å‰ï¼‰
	s.processCrossDomainJS()

	// å¦‚æœå¯ç”¨äº†é€’å½’çˆ¬å–ï¼Œç»§ç»­çˆ¬å–å‘ç°çš„é“¾æ¥
	if s.config.DepthSettings.MaxDepth > 1 {
		// ğŸ†• v3.4: æ”¯æŒå››ç§è°ƒåº¦ç®—æ³•
		// 1. BFS: å¹¿åº¦ä¼˜å…ˆï¼ˆé»˜è®¤ï¼Œå…¨é¢è¦†ç›–ï¼‰
		// 2. DFS: æ·±åº¦ä¼˜å…ˆï¼ˆå¿«é€Ÿæ·±å…¥ï¼‰
		// 3. PRIORITY_QUEUE: çº¯ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆæ™ºèƒ½ä½†å¯èƒ½é—æ¼ï¼‰
		// 4. HYBRID: æ··åˆç­–ç•¥ï¼ˆBFSæ¡†æ¶+ä¼˜å…ˆçº§æ’åºï¼Œæ¨èï¼‰âœ¨
		
		algorithm := strings.ToUpper(s.config.SchedulingSettings.Algorithm)
		
		// å¦‚æœæœªé…ç½®ï¼Œå‘ä¸‹å…¼å®¹æ—§é…ç½®
		if algorithm == "" {
			if s.config.StrategySettings.UsePriorityQueue {
				algorithm = "PRIORITY_QUEUE"
			} else {
				algorithm = s.config.DepthSettings.SchedulingAlgorithm
			}
		}
		
		// åˆå§‹åŒ–è‡ªé€‚åº”å­¦ä¹ å™¨ï¼ˆå¦‚æœå¯ç”¨æ··åˆç­–ç•¥ï¼‰
		if algorithm == "HYBRID" && s.config.SchedulingSettings.HybridConfig.EnableAdaptiveLearning {
			learningRate := s.config.SchedulingSettings.HybridConfig.LearningRate
			s.adaptiveLearner = NewAdaptivePriorityLearner(learningRate)
			s.logger.Info("è‡ªé€‚åº”ä¼˜å…ˆçº§å­¦ä¹ å™¨å·²å¯ç”¨", 
				"learning_rate", learningRate)
		}
		
		// æ ¹æ®ç®—æ³•é€‰æ‹©çˆ¬å–ç­–ç•¥
		switch algorithm {
		case "HYBRID":
			// æ··åˆç­–ç•¥ï¼šBFSæ¡†æ¶ + æ™ºèƒ½ä¼˜å…ˆçº§æ’åºï¼ˆæ¨èï¼‰
			s.logger.Info("ä½¿ç”¨æ··åˆè°ƒåº¦ç­–ç•¥", "algorithm", "HYBRID")
			s.crawlWithHybridStrategy()
			
		case "PRIORITY_QUEUE":
			// çº¯ä¼˜å…ˆçº§é˜Ÿåˆ—æ¨¡å¼
			s.logger.Info("ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—æ¨¡å¼", "algorithm", "PRIORITY_QUEUE")
			s.crawlWithPriorityQueue()
			
		case "DFS":
			// æ·±åº¦ä¼˜å…ˆï¼ˆæš‚æœªå®ç°ï¼Œå›é€€åˆ°BFSï¼‰
			s.logger.Warn("DFSæ¨¡å¼æš‚æœªå®ç°ï¼Œå›é€€åˆ°BFS", "algorithm", "DFS")
			s.crawlRecursivelyMultiLayer()
			
		default:
			// BFSæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
			s.logger.Info("ä½¿ç”¨BFSæ¨¡å¼", "algorithm", "BFS")
			s.crawlRecursivelyMultiLayer()
		}
		
		// æ‰“å°è‡ªé€‚åº”å­¦ä¹ æŠ¥å‘Šï¼ˆå¦‚æœå¯ç”¨ï¼‰
		if s.adaptiveLearner != nil {
			s.adaptiveLearner.PrintReport()
		}
	}

	return nil
}

// shouldUseDynamicCrawler åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨åŠ¨æ€çˆ¬è™«
func (s *Spider) shouldUseDynamicCrawler() bool {
	// å¦‚æœæ²¡æœ‰å‘ç°è¶³å¤Ÿçš„é“¾æ¥æˆ–APIï¼Œå¯èƒ½éœ€è¦åŠ¨æ€çˆ¬è™«
	if len(s.results) == 0 {
		return true
	}

	// æ£€æŸ¥æœ€è¿‘çš„ç»“æœ
	lastResult := s.results[len(s.results)-1]
	// é™ä½è§¦å‘åŠ¨æ€çˆ¬è™«çš„é˜ˆå€¼ï¼ˆæ›´å®¹æ˜“è§¦å‘ï¼‰
	if len(lastResult.Links) < 20 && len(lastResult.APIs) < 10 {
		return true
	}

	return false
}

// isInTargetDomain æ£€æŸ¥URLæ˜¯å¦å±äºç›®æ ‡åŸŸå
func (s *Spider) isInTargetDomain(urlStr string) bool {
	// å¿½ç•¥ç‰¹æ®Šåè®®
	if strings.HasPrefix(urlStr, "mailto:") || 
	   strings.HasPrefix(urlStr, "tel:") ||
	   strings.HasPrefix(urlStr, "javascript:") ||
	   strings.HasPrefix(urlStr, "data:") {
		return false
	}
	
	// è§£æURLæå–åŸŸå
	parsedURL, err := url.Parse(urlStr)
	if err != nil {
		return false
	}
	
	// è·å–URLçš„åŸŸåï¼ˆä¸å«ç«¯å£ï¼‰
	urlHost := parsedURL.Hostname()
	if urlHost == "" {
		return false
	}
	
	// ç›®æ ‡åŸŸåï¼ˆä¸å«ç«¯å£ï¼‰
	targetHost := s.targetDomain
	
	// å®Œå…¨åŒ¹é…
	if urlHost == targetHost {
		return true
	}
	
	// å­åŸŸååŒ¹é…ï¼ˆä¾‹å¦‚ï¼šapi.example.com åŒ¹é… example.comï¼‰
	if strings.HasSuffix(urlHost, "."+targetHost) {
		return true
	}
	
	return false
}

// addResult æ·»åŠ çˆ¬å–ç»“æœï¼ˆå¢å¼ºç‰ˆï¼šåŒ…å«DOMç›¸ä¼¼åº¦æ£€æµ‹ã€æŠ€æœ¯æ ˆæ£€æµ‹ã€æ•æ„Ÿä¿¡æ¯æ£€æµ‹å’Œç™»å½•å¢™æ£€æµ‹ï¼‰
func (s *Spider) addResult(result *Result) {
	s.mutex.Lock()
	defer s.mutex.Unlock()
	
	// ğŸ†• v3.2 ç™»å½•å¢™æ£€æµ‹
	if s.loginWallDetector != nil && result != nil {
		s.loginWallDetector.RecordPage(result.URL, result.HTMLContent)
		
		// å¦‚æœç™»å½•å¢™å æ¯”è¿‡é«˜ï¼Œå‘å‡ºè­¦å‘Š
		if s.loginWallDetector.ShouldWarn() && len(s.results) % 100 == 0 {
			// æ¯100ä¸ªé¡µé¢æ£€æŸ¥ä¸€æ¬¡
			s.loginWallDetector.PrintWarning()
		}
	}
	
	// ğŸ†• v3.5 POSTè¯·æ±‚æ£€æµ‹ï¼ˆå¢å¼ºç‰ˆï¼‰
	if s.postDetector != nil && result != nil && result.HTMLContent != "" {
		detectedPOST := s.postDetector.DetectFromHTML(result.HTMLContent, result.URL)
		if len(detectedPOST) > 0 {
			// è½¬æ¢ä¸ºResultä¸­çš„POSTRequestæ ¼å¼
			for _, dp := range detectedPOST {
				postReq := POSTRequest{
					URL:         dp.URL,
					Method:      dp.Method,
					Parameters:  dp.Parameters,
					ContentType: dp.ContentType,
					Body:        "",
					FromForm:    dp.Source == "html-form",
					FormAction:  dp.URL,
				}
				result.POSTRequests = append(result.POSTRequests, postReq)
			}
			
			s.logger.Info("æ£€æµ‹åˆ°POSTè¯·æ±‚",
				"page_url", result.URL,
				"post_count", len(detectedPOST))
		}
	}
	
	// ğŸ†• å°†åŸŸå†…URLæ·»åŠ åˆ°å»é‡å™¨ï¼ˆåªæ·»åŠ ç›®æ ‡åŸŸåçš„URLï¼‰
	if s.urlDeduplicator != nil && result != nil {
		// æ·»åŠ å½“å‰é¡µé¢URL
		if result.URL != "" && s.isInTargetDomain(result.URL) {
			s.urlDeduplicator.AddURL(result.URL)
		}
		
		// æ·»åŠ å‘ç°çš„æ‰€æœ‰é“¾æ¥ï¼ˆåªæ·»åŠ åŸŸå†…çš„ï¼‰
		if len(result.Links) > 0 {
			for _, link := range result.Links {
				if s.isInTargetDomain(link) {
					s.urlDeduplicator.AddURL(link)
				}
			}
		}
		
		// æ·»åŠ APIç«¯ç‚¹ï¼ˆåªæ·»åŠ åŸŸå†…çš„ï¼‰
		if len(result.APIs) > 0 {
			for _, api := range result.APIs {
				if s.isInTargetDomain(api) {
					s.urlDeduplicator.AddURL(api)
				}
			}
		}
		
		// æ·»åŠ è¡¨å•actionï¼ˆåªæ·»åŠ åŸŸå†…çš„ï¼‰
		for _, form := range result.Forms {
			if form.Action != "" && s.isInTargetDomain(form.Action) {
				s.urlDeduplicator.AddURL(form.Action)
			}
		}
		
		// æ·»åŠ POSTè¯·æ±‚URLï¼ˆåªæ·»åŠ åŸŸå†…çš„ï¼‰
		for _, postReq := range result.POSTRequests {
			if postReq.URL != "" && s.isInTargetDomain(postReq.URL) {
				s.urlDeduplicator.AddURL(postReq.URL)
			}
		}
	}

	// å¦‚æœæœ‰HTMLå†…å®¹ï¼Œå…ˆè¿›è¡ŒDOMç›¸ä¼¼åº¦æ£€æµ‹
	if result.HTMLContent != "" && s.domSimilarity != nil {
		isSimilar, record := s.domSimilarity.CheckSimilarity(result.URL, result.HTMLContent)
		if isSimilar && record != nil {
			fmt.Printf("  [DOMç›¸ä¼¼åº¦] å‘ç°ç›¸ä¼¼é¡µé¢ï¼ç›¸ä¼¼åº¦: %.1f%%, ç›¸ä¼¼äº: %s\n",
				record.Similarity*100, record.SimilarToURL)
			fmt.Printf("  [DOMç›¸ä¼¼åº¦] åŸå› : %s\n", record.Reason)
			fmt.Printf("  [DOMç›¸ä¼¼åº¦] âœ“ è·³è¿‡é‡å¤çˆ¬å–ï¼ŒèŠ‚çœèµ„æº\n")
			// ç›¸ä¼¼é¡µé¢ä»ç„¶è®°å½•ï¼Œä½†æ ‡è®°ä¸ºå·²è·³è¿‡
			result.IsSimilar = true
			result.SimilarToURL = record.SimilarToURL
		}
	}

	s.results = append(s.results, result)

	// å¦‚æœæœ‰HTMLå†…å®¹ï¼Œè¿›è¡Œé«˜çº§æ£€æµ‹
	if result.HTMLContent != "" {
		// æŠ€æœ¯æ ˆæ£€æµ‹
		if s.techDetector != nil {
			techs := s.techDetector.DetectFromContent(result.HTMLContent, result.Headers)
			s.detectedTechs = append(s.detectedTechs, techs...)

			if len(techs) > 0 {
				techNames := make([]string, 0)
				for _, tech := range techs {
					if tech.Version != "" {
						techNames = append(techNames, tech.Name+" "+tech.Version)
					} else {
						techNames = append(techNames, tech.Name)
					}
				}
				fmt.Printf("  [æŠ€æœ¯æ ˆ] æ£€æµ‹åˆ°: %s\n", strings.Join(techNames, ", "))
			}
		}

		// æ•æ„Ÿä¿¡æ¯æ£€æµ‹ï¼ˆæ ¹æ®é…ç½®å†³å®šæ˜¯å¦å¯ç”¨ï¼‰
		if s.config.SensitiveDetectionSettings.Enabled && s.sensitiveDetector != nil {
			findings := make([]*SensitiveInfo, 0)
			
			// æ‰«æHTMLå†…å®¹ï¼ˆæ ¹æ®é…ç½®ï¼‰
			if s.config.SensitiveDetectionSettings.ScanResponseBody {
				bodyFindings := s.sensitiveDetector.Scan(result.HTMLContent, result.URL)
				findings = append(findings, bodyFindings...)
				s.sensitiveFindings = append(s.sensitiveFindings, bodyFindings...)
			}

			// æ‰«æHTTPå¤´ï¼ˆæ ¹æ®é…ç½®ï¼‰
			if s.config.SensitiveDetectionSettings.ScanResponseHeaders && len(result.Headers) > 0 {
				headerContent := ""
				for key, value := range result.Headers {
					headerContent += key + ": " + value + "\n"
				}
				headerFindings := s.sensitiveDetector.Scan(headerContent, result.URL+" (Headers)")
				s.sensitiveFindings = append(s.sensitiveFindings, headerFindings...)
				findings = append(findings, headerFindings...)
			}

			// å®æ—¶è¾“å‡ºï¼ˆæ ¹æ®é…ç½®ï¼‰
			if s.config.SensitiveDetectionSettings.RealTimeOutput && len(findings) > 0 {
				// æŒ‰ä¸¥é‡çº§åˆ«è¿‡æ»¤
				filteredFindings := s.filterBySeverity(findings)
				
				if len(filteredFindings) > 0 {
					highCount := 0
					for _, finding := range filteredFindings {
						if finding.Severity == "HIGH" {
							highCount++
						}
					}

					if highCount > 0 {
						fmt.Printf("  [æ•æ„Ÿä¿¡æ¯] âš ï¸  å‘ç° %d å¤„é«˜å±æ•æ„Ÿä¿¡æ¯ï¼\n", highCount)
					} else {
						fmt.Printf("  [æ•æ„Ÿä¿¡æ¯] å‘ç° %d å¤„æ•æ„Ÿä¿¡æ¯\n", len(filteredFindings))
					}
				}
			}
		}
	}
	
	// v2.7: ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤å™¨ - è‡ªé€‚åº”å­¦ä¹ 
	if s.config.DeduplicationSettings.EnableBusinessAwareFilter && 
	   s.config.DeduplicationSettings.BusinessFilterAdaptiveLearning {
		// è®¡ç®—å“åº”æ—¶é—´ï¼ˆå¦‚æœå¯ç”¨ï¼‰
		responseTime := 0.0
		
		// æ£€æŸ¥æ˜¯å¦å‘ç°æ–°å†…å®¹
		hasNewLinks := len(result.Links) > 0
		hasNewForms := len(result.Forms) > 0
		hasNewAPIs := len(result.APIs) > 0
		
		// æ›´æ–°çˆ¬å–ç»“æœï¼Œç”¨äºè‡ªé€‚åº”å­¦ä¹ 
		s.businessFilter.UpdateCrawlResult(
			result.URL,
			result.StatusCode,
			responseTime,
			hasNewLinks,
			hasNewForms,
			hasNewAPIs,
		)
	}
}

// addResultWithDetection æ·»åŠ ç»“æœå¹¶è¿›è¡Œæ£€æµ‹
func (s *Spider) addResultWithDetection(result *Result, response *http.Response, htmlContent string) {
	s.mutex.Lock()
	defer s.mutex.Unlock()

	s.results = append(s.results, result)

	// æŠ€æœ¯æ ˆæ£€æµ‹
	if response != nil && s.techDetector != nil {
		techs := s.techDetector.Detect(response, htmlContent)
		s.detectedTechs = append(s.detectedTechs, techs...)

		if len(techs) > 0 {
			fmt.Printf("  [æŠ€æœ¯æ ˆ] æ£€æµ‹åˆ°: ")
			techNames := make([]string, 0)
			for _, tech := range techs {
				if tech.Version != "" {
					techNames = append(techNames, tech.Name+" "+tech.Version)
				} else {
					techNames = append(techNames, tech.Name)
				}
			}
			fmt.Printf("%s\n", strings.Join(techNames, ", "))
		}
	}

	// æ•æ„Ÿä¿¡æ¯æ£€æµ‹
	if s.sensitiveDetector != nil {
		findings := s.sensitiveDetector.Scan(htmlContent, result.URL)
		s.sensitiveFindings = append(s.sensitiveFindings, findings...)

		if len(findings) > 0 {
			highCount := 0
			for _, finding := range findings {
				if finding.Severity == "HIGH" {
					highCount++
				}
			}

			if highCount > 0 {
				fmt.Printf("  [æ•æ„Ÿä¿¡æ¯] âš ï¸  å‘ç° %d å¤„é«˜å±æ•æ„Ÿä¿¡æ¯ï¼\n", highCount)
			} else {
				fmt.Printf("  [æ•æ„Ÿä¿¡æ¯] å‘ç° %d å¤„æ•æ„Ÿä¿¡æ¯\n", len(findings))
			}
		}
	}

	// å­åŸŸåæå–
	if s.subdomainExtractor != nil && htmlContent != "" {
		// ä»HTMLå†…å®¹æå–å­åŸŸå
		subdomains := s.subdomainExtractor.ExtractFromHTML(htmlContent)
		if len(subdomains) > 0 {
			fmt.Printf("  [å­åŸŸå] å‘ç° %d ä¸ªæ–°å­åŸŸå\n", len(subdomains))
		}

		// ä»URLæœ¬èº«æå–
		s.subdomainExtractor.ExtractFromURL(result.URL)
	}
}

// GetResults è·å–æ‰€æœ‰çˆ¬å–ç»“æœ
func (s *Spider) GetResults() []*Result {
	s.mutex.Lock()
	defer s.mutex.Unlock()

	// v2.6.1: æ‰“å°æ™ºèƒ½å‚æ•°å€¼å»é‡ç»Ÿè®¡
	if s.config.DeduplicationSettings.EnableSmartParamDedup && s.smartParamDedup != nil {
		s.smartParamDedup.PrintStatistics()
	}

	// è¿”å›ç»“æœå‰¯æœ¬
	results := make([]*Result, len(s.results))
	copy(results, s.results)
	return results
}

// processParams å·²åºŸå¼ƒï¼ˆå‚æ•°çˆ†ç ´åŠŸèƒ½å·²ç§»é™¤ï¼‰
// ä¿ç•™å®šä¹‰ä»¥é¿å…ç¼–è¯‘é”™è¯¯ï¼Œä½†ä¸å†ä½¿ç”¨
func (s *Spider) processParams(rawURL string) []string {
	// å‚æ•°çˆ†ç ´åŠŸèƒ½å·²ç§»é™¤ï¼Œç›´æ¥è¿”å›åŸå§‹URL
	return []string{rawURL}
}

/*
// ä»¥ä¸‹æ˜¯åŸ processParams çš„ä»£ç ï¼ˆå·²åºŸå¼ƒï¼‰
func (s *Spider) processParamsOLD(rawURL string) []string {
	// æå–å‚æ•°
	params, err := s.paramHandler.ExtractParams(rawURL)
	if err != nil {
		// å¦‚æœæå–å‚æ•°å¤±è´¥ï¼Œè‡³å°‘è¿”å›åŸå§‹URL
		return []string{rawURL}
	}

	// ===  ä¿®å¤ï¼šé˜²æ­¢å‚æ•°çˆ†ç ´æ— é™é€’å½’ ===
	// æ£€æµ‹URLæ˜¯å¦å¯èƒ½æ˜¯å‚æ•°çˆ†ç ´ç”Ÿæˆçš„ï¼ˆé¿å…å¯¹çˆ†ç ´ç»“æœå†æ¬¡çˆ†ç ´ï¼‰
	if len(params) > 0 && s.config.StrategySettings.EnableParamFuzzing {
		// å®Œæ•´çš„å‚æ•°çˆ†ç ´å‚æ•°åˆ—è¡¨ï¼ˆæ¥è‡ªGenerateParameterFuzzListï¼‰
		fuzzedParamNames := []string{
			// é€šç”¨å‚æ•°
			"id", "page", "limit", "offset", "sort", "order", "search", "q", "query",
			"filter", "category", "type", "status", "action", "method", "format",
			// ç”¨æˆ·ç›¸å…³
			"user", "username", "userid", "uid", "email", "password", "pass", "pwd",
			"token", "auth", "session", "key", "api_key", "access_token",
			// æ–‡ä»¶ç›¸å…³
			"file", "filename", "path", "dir", "folder", "upload", "download",
			"image", "img", "pic", "photo", "document", "doc", "pdf",
			// å…¶ä»–å¸¸è§å‚æ•°
			"debug", "test", "dev", "admin", "config",
		}

		// æµ‹è¯•å€¼åˆ—è¡¨ï¼ˆç”¨äºæ£€æµ‹å‚æ•°å€¼æ˜¯å¦æ˜¯æµ‹è¯•å€¼ï¼‰
		testValues := []string{"1", "test", "admin", "null", "../", "", "false", "true"}

		fuzzedParamCount := 0
		originalParamCount := 0
		testValueCount := 0

		parsedURL, _ := url.Parse(rawURL)
		if parsedURL != nil {
			queryParams := parsedURL.Query()
			for paramName, values := range queryParams {
				// æ£€æŸ¥å‚æ•°åæ˜¯å¦æ˜¯çˆ†ç ´å‚æ•°
				isFuzzedParam := false
				for _, fuzzName := range fuzzedParamNames {
					if paramName == fuzzName {
						isFuzzedParam = true
						fuzzedParamCount++
						break
					}
				}
				if !isFuzzedParam {
					originalParamCount++
				}

				// æ£€æŸ¥å‚æ•°å€¼æ˜¯å¦æ˜¯æµ‹è¯•å€¼
				if len(values) > 0 {
					paramValue := values[0]
					for _, testVal := range testValues {
						if paramValue == testVal || strings.Contains(paramValue, testVal) {
							testValueCount++
							break
						}
					}
				}
			}

			// åˆ¤æ–­æ˜¯å¦æ˜¯çˆ†ç ´ç”Ÿæˆçš„URLï¼ˆä¼˜åŒ–åçš„æ£€æµ‹è§„åˆ™ï¼‰ï¼š
			// æ ¸å¿ƒåŸåˆ™ï¼šåªè·³è¿‡"çº¯ç²¹ç”±çˆ†ç ´ç”Ÿæˆ"çš„URLï¼Œä¸è¯¯æ€çœŸå®URL
			//
			// è§„åˆ™1ï¼šåŒ…å«2ä¸ªä»¥ä¸Šçˆ†ç ´å‚æ•°ï¼ˆå¦‚ ?id=1&page=1ï¼‰
			// è§„åˆ™2ï¼šåªæœ‰çˆ†ç ´å‚æ•°ï¼Œæ²¡æœ‰åŸå§‹å‚æ•°ï¼ˆå¦‚ ?search=1, ?limit=ï¼‰
			//
			// ä¸è·³è¿‡çš„æƒ…å†µï¼š
			// - çœŸå®å‚æ•°+çˆ†ç ´å‚æ•°çš„ç»„åˆï¼ˆå¦‚ ?article_id=123&id=1ï¼‰
			// - çœŸå®å‚æ•°ç¢°å·§å€¼æ˜¯æµ‹è¯•å€¼ï¼ˆå¦‚ ?article_id=1ï¼‰
			shouldSkip := false
			skipReason := ""

			if fuzzedParamCount >= 2 {
				// è§„åˆ™1ï¼šå¤šä¸ªçˆ†ç ´å‚æ•°ï¼Œæ˜æ˜¾æ˜¯çˆ†ç ´ç”Ÿæˆçš„
				shouldSkip = true
				skipReason = fmt.Sprintf("åŒ…å«%dä¸ªçˆ†ç ´å‚æ•°", fuzzedParamCount)
			} else if fuzzedParamCount >= 1 && originalParamCount == 0 {
				// è§„åˆ™2ï¼šåªæœ‰çˆ†ç ´å‚æ•°ï¼Œæ²¡æœ‰åŸå§‹å‚æ•°
				// ä¾‹å¦‚ï¼š?search=1, ?limit=, ?id=1
				shouldSkip = true
				skipReason = fmt.Sprintf("åªåŒ…å«çˆ†ç ´å‚æ•°ï¼ˆ%dä¸ªï¼‰ï¼Œæ— åŸå§‹å‚æ•°", fuzzedParamCount)
			}

			if shouldSkip {
				fmt.Printf("ä¸ºURL %s ç”Ÿæˆ %d ä¸ªå‚æ•°å˜ä½“\n", rawURL, 1)
				fmt.Printf("  å˜ä½“: %s\n", rawURL)
				fmt.Printf("  [å‚æ•°çˆ†ç ´] æ£€æµ‹åˆ°è¯¥URLå¯èƒ½æ˜¯çˆ†ç ´ç”Ÿæˆçš„ï¼ˆ%sï¼‰ï¼Œè·³è¿‡å†æ¬¡çˆ†ç ´\n", skipReason)
				return []string{rawURL}
			}
		}
	}

	// === æ–°å¢ï¼šå¯¹æ— å‚æ•°URLè¿›è¡Œå‚æ•°çˆ†ç ´ ===
	if len(params) == 0 && s.config.StrategySettings.EnableParamFuzzing {
		fmt.Printf("  [å‚æ•°çˆ†ç ´] æ£€æµ‹åˆ°æ— å‚æ•°URLï¼Œå¼€å§‹å‚æ•°æšä¸¾...\n")

		// ç”Ÿæˆå‚æ•°çˆ†ç ´åˆ—è¡¨
		fuzzList := s.paramHandler.GenerateParameterFuzzList(rawURL)

		// åº”ç”¨é™åˆ¶ï¼ˆé¿å…ç”Ÿæˆè¿‡å¤šURLï¼‰
		if s.config.StrategySettings.ParamFuzzLimit > 0 && len(fuzzList) > s.config.StrategySettings.ParamFuzzLimit {
			fuzzList = fuzzList[:s.config.StrategySettings.ParamFuzzLimit]
			fmt.Printf("  [å‚æ•°çˆ†ç ´] é™åˆ¶çˆ†ç ´æ•°é‡ä¸º %d ä¸ªï¼ˆå¯é…ç½®ï¼‰\n", s.config.StrategySettings.ParamFuzzLimit)
		}

		if len(fuzzList) > 0 {
			fmt.Printf("  [å‚æ•°çˆ†ç ´] ä¸ºæ— å‚æ•°URLç”Ÿæˆ %d ä¸ªå‚æ•°çˆ†ç ´å˜ä½“\n", len(fuzzList))
			fmt.Printf("  [å‚æ•°çˆ†ç ´] ç¤ºä¾‹: %s\n", fuzzList[0])
			if len(fuzzList) > 1 {
				fmt.Printf("  [å‚æ•°çˆ†ç ´] ç¤ºä¾‹: %s\n", fuzzList[1])
			}
			if len(fuzzList) > 2 {
				fmt.Printf("  [å‚æ•°çˆ†ç ´] ç¤ºä¾‹: %s\n", fuzzList[2])
			}
			fmt.Printf("  [å‚æ•°çˆ†ç ´] ... è¿˜æœ‰ %d ä¸ªçˆ†ç ´URL\n", len(fuzzList)-3)

			return fuzzList
		}

		// å¦‚æœçˆ†ç ´å¤±è´¥ï¼Œè¿”å›åŸå§‹URL
		return []string{rawURL}
	}

	// === åŸæœ‰é€»è¾‘ï¼šå¯¹æœ‰å‚æ•°URLè¿›è¡Œå˜ä½“ç”Ÿæˆï¼ˆçº¯çˆ¬è™«æ¨¡å¼ï¼Œä¸å«æ”»å‡»payloadï¼‰ ===
	// å¯¹æ¯ä¸ªå‚æ•°è¿›è¡Œä¿¡æ¯åˆ†æï¼ˆä»…è®°å½•ï¼Œä¸ç”¨äºæ”»å‡»ï¼‰
	for paramName := range params {
		risk, level := s.paramHandler.AnalyzeParameterSecurity(paramName)
		if level >= 2 { // ä¸­ç­‰é£é™©ä»¥ä¸Š
			finding := fmt.Sprintf("PARAM_INFO: %s - %s (Risk Level: %d)", paramName, risk, level)
			s.mutex.Lock()
			s.securityFindings = append(s.securityFindings, finding)
			s.mutex.Unlock()
			fmt.Printf("  [å‚æ•°åˆ†æ] %s\n", finding)
		}
	}

	// ç”Ÿæˆå‚æ•°å˜ä½“ï¼ˆåªä½¿ç”¨æ­£å¸¸å€¼ï¼Œä¸å«æ”»å‡»payloadï¼‰
	variations := s.paramHandler.GenerateParamVariations(rawURL)

	// === ç§»é™¤ï¼šå®‰å…¨æµ‹è¯•å˜ä½“ï¼ˆæ”»å‡»æ€§payloadï¼‰ ===
	// ä½œä¸ºçº¯çˆ¬è™«å·¥å…·ï¼Œä¸åº”å‘é€SQLæ³¨å…¥ã€XSSç­‰æ”»å‡»æ€§payload
	// securityVariations := s.paramHandler.GenerateSecurityTestVariations(rawURL)
	// variations = append(variations, securityVariations...)

	// å¦‚æœæ²¡æœ‰ç”Ÿæˆå˜ä½“ï¼Œè¿”å›åŸå§‹URL
	if len(variations) == 0 {
		return []string{rawURL}
	}

	// æ‰“å°ç”Ÿæˆçš„å˜ä½“
	fmt.Printf("  [å‚æ•°å˜ä½“] ä¸ºURLç”Ÿæˆ %d ä¸ªå‚æ•°å˜ä½“ï¼ˆæ­£å¸¸æµ‹è¯•å€¼ï¼‰\n", len(variations))
	for i, variation := range variations {
		if i < 5 { // åªæ˜¾ç¤ºå‰5ä¸ªï¼Œé¿å…è¾“å‡ºè¿‡å¤š
			fmt.Printf("    å˜ä½“: %s\n", variation)
		}
	}
	if len(variations) > 5 {
		fmt.Printf("    ... è¿˜æœ‰ %d ä¸ªå˜ä½“\n", len(variations)-5)
	}

	return variations
}
*/

// processForms å·²åºŸå¼ƒï¼ˆPOSTå‚æ•°çˆ†ç ´åŠŸèƒ½å·²ç§»é™¤ï¼‰
// ä¿ç•™å®šä¹‰ä»¥é¿å…ç¼–è¯‘é”™è¯¯ï¼Œä½†ä¸å†ä½¿ç”¨
func (s *Spider) processForms(targetURL string) {
	// POSTå‚æ•°çˆ†ç ´åŠŸèƒ½å·²ç§»é™¤
	return
}

/*
// ä»¥ä¸‹æ˜¯åŸ processForms çš„ä»£ç ï¼ˆå·²åºŸå¼ƒï¼‰
func (s *Spider) processFormsOLD(targetURL string) {
	// æ£€æŸ¥æ˜¯å¦å¯ç”¨POSTå‚æ•°çˆ†ç ´
	if !s.config.StrategySettings.EnablePOSTParamFuzzing {
		return
	}

	s.mutex.Lock()
	defer s.mutex.Unlock()

	// æ”¶é›†æ‰€æœ‰ç©ºè¡¨å•æˆ–æ— æ•ˆè¡¨å•
	emptyForms := make([]string, 0)
	totalForms := 0

	for _, result := range s.results {
		totalForms += len(result.Forms)

		for _, form := range result.Forms {
			// æ£€æŸ¥è¡¨å•æ˜¯å¦æœ‰æœ‰æ•ˆå­—æ®µ
			hasValidFields := false
			for _, field := range form.Fields {
				// è·³è¿‡æäº¤æŒ‰é’®å’Œæ™®é€šæŒ‰é’®
				fieldTypeLower := strings.ToLower(field.Type)
				if fieldTypeLower != "submit" && fieldTypeLower != "button" && field.Name != "" {
					hasValidFields = true
					break
				}
			}

			// å¦‚æœè¡¨å•æ²¡æœ‰æœ‰æ•ˆå­—æ®µï¼Œæ·»åŠ åˆ°çˆ†ç ´åˆ—è¡¨
			if !hasValidFields {
				emptyForms = append(emptyForms, form.Action)
			}
		}

		// åŒæ ·æ£€æŸ¥POSTè¯·æ±‚
		for _, postReq := range result.POSTRequests {
			// å¦‚æœPOSTè¯·æ±‚æ²¡æœ‰å‚æ•°æˆ–å‚æ•°ä¸ºç©º
			if len(postReq.Parameters) == 0 {
				emptyForms = append(emptyForms, postReq.URL)
			}
		}
	}

	// å»é‡
	uniqueEmptyForms := make(map[string]bool)
	for _, formURL := range emptyForms {
		uniqueEmptyForms[formURL] = true
	}

	if len(uniqueEmptyForms) == 0 {
		if totalForms > 0 {
			fmt.Printf("  [POSTçˆ†ç ´] å‘ç° %d ä¸ªè¡¨å•ï¼Œå…¨éƒ¨æœ‰å­—æ®µï¼Œæ— éœ€çˆ†ç ´\n", totalForms)
		}
		return
	}

	fmt.Printf("  [POSTçˆ†ç ´] æ£€æµ‹åˆ° %d ä¸ªç©ºè¡¨å•ï¼Œå¼€å§‹POSTå‚æ•°çˆ†ç ´...\n", len(uniqueEmptyForms))

	// å¯¹æ¯ä¸ªç©ºè¡¨å•ç”ŸæˆPOSTçˆ†ç ´è¯·æ±‚
	totalPOSTFuzzRequests := 0
	for formURL := range uniqueEmptyForms {
		// ç”ŸæˆPOSTå‚æ•°çˆ†ç ´åˆ—è¡¨
		postFuzzList := s.paramHandler.GeneratePOSTParameterFuzzList(formURL)

		// åº”ç”¨é™åˆ¶
		if s.config.StrategySettings.POSTParamFuzzLimit > 0 && len(postFuzzList) > s.config.StrategySettings.POSTParamFuzzLimit {
			postFuzzList = postFuzzList[:s.config.StrategySettings.POSTParamFuzzLimit]
		}

		if len(postFuzzList) > 0 {
			// æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªç»“æœçš„POSTRequestsä¸­
			if len(s.results) > 0 {
				s.results[0].POSTRequests = append(s.results[0].POSTRequests, postFuzzList...)
			}
			totalPOSTFuzzRequests += len(postFuzzList)
		}
	}

	if totalPOSTFuzzRequests > 0 {
		fmt.Printf("  [POSTçˆ†ç ´] ä¸º %d ä¸ªç©ºè¡¨å•ç”Ÿæˆ %d ä¸ªPOSTçˆ†ç ´è¯·æ±‚\n", len(uniqueEmptyForms), totalPOSTFuzzRequests)
		fmt.Printf("  [POSTçˆ†ç ´] ç¤ºä¾‹: POST %s {username=admin, password=admin123}\n", emptyForms[0])
		if len(uniqueEmptyForms) > 1 {
			fmt.Printf("  [POSTçˆ†ç ´] ç¤ºä¾‹: POST %s {search=test, q=admin}\n", emptyForms[0])
		}
	}
}
*/

// processCrossDomainJS å¤„ç†è·¨åŸŸJSæ–‡ä»¶
func (s *Spider) processCrossDomainJS() {
	fmt.Println("\nå¼€å§‹åˆ†æè·¨åŸŸJSæ–‡ä»¶...")

	// æ”¶é›†æ‰€æœ‰èµ„æºé“¾æ¥
	allAssets := make(map[string]bool)

	s.mutex.Lock()
	for _, result := range s.results {
		for _, asset := range result.Assets {
			allAssets[asset] = true
		}
		// ä¹Ÿæ£€æŸ¥Linksä¸­çš„JSæ–‡ä»¶
		for _, link := range result.Links {
			if strings.HasSuffix(strings.ToLower(link), ".js") {
				allAssets[link] = true
			}
		}
	}
	s.mutex.Unlock()

	// è¿‡æ»¤å‡ºéœ€è¦åˆ†æçš„JSæ–‡ä»¶
	jsToAnalyze := make([]string, 0)
	for asset := range allAssets {
		// æ£€æŸ¥æ˜¯å¦ä¸ºJSæ–‡ä»¶
		if !strings.HasSuffix(strings.ToLower(asset), ".js") {
			continue
		}

		// è§£æURL
		parsedURL, err := url.Parse(asset)
		if err != nil {
			continue
		}

		domain := parsedURL.Host
		if domain == "" {
			continue
		}

		// æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ†æ
		shouldAnalyze := false
		reason := ""

		// 1. æ˜¯ç›®æ ‡åŸŸå - å·²ç»æ­£å¸¸çˆ¬å–äº†ï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†
		if domain == s.targetDomain {
			continue
		}

		// 2. æ˜¯åŒæºåŸŸå
		if s.cdnDetector.IsSameBaseDomain(domain, s.targetDomain) {
			shouldAnalyze = true
			reason = "åŒæºåŸŸå"
		}

		// 3. æ˜¯å·²çŸ¥CDN
		if s.cdnDetector.IsCDN(domain) {
			shouldAnalyze = true
			cdnInfo := s.cdnDetector.GetCDNInfo(domain)
			reason = cdnInfo
		}

		if shouldAnalyze {
			jsToAnalyze = append(jsToAnalyze, asset)
			fmt.Printf("  å‘ç°è·¨åŸŸJS: %s (%s)\n", asset, reason)
		}
	}

	if len(jsToAnalyze) == 0 {
		fmt.Println("æœªå‘ç°éœ€è¦åˆ†æçš„è·¨åŸŸJSæ–‡ä»¶")
		return
	}

	fmt.Printf("å‡†å¤‡åˆ†æ %d ä¸ªè·¨åŸŸJSæ–‡ä»¶...\n", len(jsToAnalyze))

	// åˆ†ææ¯ä¸ªJSæ–‡ä»¶
	totalURLsFound := 0
	for _, jsURL := range jsToAnalyze {
		urls := s.analyzeExternalJS(jsURL)
		if len(urls) > 0 {
			fmt.Printf("  ä» %s æå–äº† %d ä¸ªURL\n", jsURL, len(urls))
			totalURLsFound += len(urls)

			// æ·»åŠ åˆ°è·¨åŸŸJSå‘ç°åˆ—è¡¨
			s.mutex.Lock()
			s.crossDomainJS = append(s.crossDomainJS, urls...)
			s.mutex.Unlock()

			// æ·»åŠ åˆ°çˆ¬å–é˜Ÿåˆ—ï¼ˆå¦‚æœå¯ç”¨é€’å½’çˆ¬å–ï¼‰
			if s.config.DepthSettings.MaxDepth > 1 {
				addedCount := 0
				filteredCount := 0
				for _, u := range urls {
					// ğŸ†• v3.5: ä½¿ç”¨URLéªŒè¯å™¨è¿‡æ»¤æ— æ•ˆURL
					if s.urlValidator != nil && !s.urlValidator.IsValidBusinessURL(u) {
						filteredCount++
						continue
					}
					
					// æ·»åŠ åˆ°ç»“æœä¸­ï¼ˆä½œä¸ºå‘ç°çš„é“¾æ¥ï¼‰
					if len(s.results) > 0 {
						s.results[0].Links = append(s.results[0].Links, u)
						addedCount++
					}
				}
				if filteredCount > 0 {
					fmt.Printf("    [è·¨åŸŸJSè¿‡æ»¤] è¿‡æ»¤äº† %d ä¸ªæ— æ•ˆURLï¼Œä¿ç•™ %d ä¸ªæœ‰æ•ˆURL\n", filteredCount, addedCount)
				}
			}
		}
	}

	fmt.Printf("è·¨åŸŸJSåˆ†æå®Œæˆï¼å…±ä» %d ä¸ªJSæ–‡ä»¶ä¸­æå–äº† %d ä¸ªç›®æ ‡åŸŸåURL\n\n", len(jsToAnalyze), totalURLsFound)
}

// analyzeExternalJS ä¸‹è½½å¹¶åˆ†æå¤–éƒ¨JSæ–‡ä»¶ï¼ˆä½¿ç”¨æ€§èƒ½ä¼˜åŒ–ï¼‰
func (s *Spider) analyzeExternalJS(jsURL string) []string {
	// ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–çš„HTTPå®¢æˆ·ç«¯
	req, err := http.NewRequest("GET", jsURL, nil)
	if err != nil {
		fmt.Printf("    åˆ›å»ºè¯·æ±‚å¤±è´¥: %v\n", err)
		return []string{}
	}

	// è®¾ç½®User-Agent
	if len(s.config.AntiDetectionSettings.UserAgents) > 0 {
		req.Header.Set("User-Agent", s.config.AntiDetectionSettings.UserAgents[0])
	} else {
		req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")
	}

	// ä½¿ç”¨ä¼˜åŒ–çš„HTTPå®¢æˆ·ç«¯ï¼ˆå¸¦è¿æ¥æ± ï¼‰
	resp, err := s.perfOptimizer.DoRequest(req)
	if err != nil {
		fmt.Printf("    ä¸‹è½½å¤±è´¥: %v\n", err)
		return []string{}
	}
	defer resp.Body.Close()

	// æ£€æŸ¥çŠ¶æ€ç 
	if resp.StatusCode != 200 {
		fmt.Printf("    HTTP %d\n", resp.StatusCode)
		return []string{}
	}

	// ä½¿ç”¨Bufferæ± è¯»å–å†…å®¹
	buf := s.perfOptimizer.GetBuffer()
	defer s.perfOptimizer.PutBuffer(buf)

	// é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
	const maxSize = 5 * 1024 * 1024
	limitedReader := &io.LimitedReader{R: resp.Body, N: maxSize}

	_, err = buf.ReadFrom(limitedReader)
	if err != nil {
		fmt.Printf("    è¯»å–å†…å®¹å¤±è´¥: %v\n", err)
		return []string{}
	}

	// ä½¿ç”¨å¢å¼ºçš„JSåˆ†æå™¨æå–URL
	jsCode := buf.String()

	// ä½¿ç”¨å¢å¼ºåˆ†æ
	enhancedResult := s.jsAnalyzer.EnhancedAnalyze(jsCode)

	// åˆå¹¶æ‰€æœ‰å‘ç°çš„URL
	urls := make([]string, 0)
	seen := make(map[string]bool)
	relativeURLs := make([]string, 0)  // âœ… ä¿®å¤9: æ”¶é›†ç›¸å¯¹URL

	for category, categoryURLs := range enhancedResult {
		for _, discoveredURL := range categoryURLs {
			if !seen[discoveredURL] {
				seen[discoveredURL] = true
				
				// âœ… ä¿®å¤9: æ£€æŸ¥æ˜¯å¦ä¸ºç›¸å¯¹URLæˆ–è·¯å¾„
				if isRelativeURL(discoveredURL) {
					relativeURLs = append(relativeURLs, discoveredURL)
				} else {
					urls = append(urls, discoveredURL)
				}
			}
		}

		// æ‰“å°å„ç±»åˆ«çš„å‘ç°
		if len(categoryURLs) > 0 {
			fmt.Printf("    [%s] å‘ç° %d ä¸ªURL\n", category, len(categoryURLs))
		}
	}
	
	// âœ… ä¿®å¤9: å°†ç›¸å¯¹URLä¸ç›®æ ‡åŸŸåæ‹¼æ¥
	if len(relativeURLs) > 0 {
		fmt.Printf("    [CDN JSæ‹¼æ¥] å‘ç° %d ä¸ªç›¸å¯¹URL,ä¸ç›®æ ‡åŸŸåæ‹¼æ¥...\n", len(relativeURLs))
		baseURL := fmt.Sprintf("https://%s", s.targetDomain)
		if parsedBase, err := url.Parse(baseURL); err == nil {
			for _, relURL := range relativeURLs {
				absoluteURL := parsedBase.ResolveReference(&url.URL{Path: relURL})
				fullURL := absoluteURL.String()
				if !seen[fullURL] {
					seen[fullURL] = true
					urls = append(urls, fullURL)
					fmt.Printf("      æ‹¼æ¥: %s + %s = %s\n", baseURL, relURL, fullURL)
				}
			}
		}
	}

	return urls
}

// crawlRecursively é€’å½’çˆ¬å–å‘ç°çš„é“¾æ¥ï¼ˆå•å±‚çˆ¬å–ï¼Œå·²åºŸå¼ƒï¼‰
// è¯·ä½¿ç”¨ crawlRecursivelyMultiLayer
func (s *Spider) crawlRecursively() {
	s.crawlRecursivelyMultiLayer()
}

// crawlRecursivelyMultiLayer çœŸæ­£çš„å¤šå±‚é€’å½’çˆ¬å–ï¼ˆä¿®å¤æ·±åº¦é—®é¢˜ï¼‰
func (s *Spider) crawlRecursivelyMultiLayer() {
	fmt.Println("å¼€å§‹å¤šå±‚é€’å½’çˆ¬å–...")

	currentDepth := 1
	totalCrawled := 0

	// å¾ªç¯çˆ¬å–æ¯ä¸€å±‚ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§æ·±åº¦
	for currentDepth < s.config.DepthSettings.MaxDepth {
		currentDepth++

		fmt.Printf("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
		fmt.Printf("ã€ç¬¬ %d å±‚çˆ¬å–ã€‘æœ€å¤§æ·±åº¦: %d\n", currentDepth, s.config.DepthSettings.MaxDepth)
		fmt.Printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")

		// æ”¶é›†å½“å‰å±‚éœ€è¦çˆ¬å–çš„é“¾æ¥
		layerLinks := s.collectLinksForLayer(currentDepth)

		if len(layerLinks) == 0 {
			fmt.Printf("ç¬¬ %d å±‚æ²¡æœ‰æ–°é“¾æ¥ï¼Œé€’å½’ç»“æŸ\n", currentDepth)
			break
		}

		fmt.Printf("ç¬¬ %d å±‚å‡†å¤‡çˆ¬å– %d ä¸ªé“¾æ¥...\n", currentDepth, len(layerLinks))

		// çˆ¬å–å½“å‰å±‚çš„æ‰€æœ‰é“¾æ¥
		newResults := s.crawlLayer(layerLinks, currentDepth)

		// åˆå¹¶ç»“æœ
		s.mutex.Lock()
		s.results = append(s.results, newResults...)
		s.mutex.Unlock()

		totalCrawled += len(layerLinks)
		fmt.Printf("ç¬¬ %d å±‚çˆ¬å–å®Œæˆï¼æœ¬å±‚çˆ¬å– %d ä¸ªURLï¼Œç´¯è®¡ %d ä¸ª\n",
			currentDepth, len(layerLinks), totalCrawled)

		// æ£€æŸ¥æ˜¯å¦è¾¾åˆ°URLé™åˆ¶
		if totalCrawled >= 500 {
			fmt.Printf("å·²è¾¾åˆ°URLé™åˆ¶(500)ï¼Œé€’å½’ç»“æŸ\n")
			break
		}
	}

	fmt.Printf("\nå¤šå±‚é€’å½’çˆ¬å–å®Œæˆï¼æ€»å…±çˆ¬å– %d ä¸ªURLï¼Œæ·±åº¦ %d å±‚\n", totalCrawled, currentDepth)
}

// collectLinksForLayer æ”¶é›†æŒ‡å®šå±‚éœ€è¦çˆ¬å–çš„é“¾æ¥
func (s *Spider) collectLinksForLayer(targetDepth int) []string {
	allLinks := make(map[string]bool)
	externalLinks := make([]string, 0)

	s.mutex.Lock()
	// ä»æ‰€æœ‰ç»“æœä¸­æ”¶é›†é“¾æ¥
	for _, result := range s.results {
		for _, link := range result.Links {
			// æ£€æŸ¥æ˜¯å¦å·²è®¿é—®
			if s.visitedURLs[link] {
				continue
			}

			// è§£æé“¾æ¥
			parsedURL, err := url.Parse(link)
			if err != nil {
				continue
			}

			// ä½œç”¨åŸŸæ£€æŸ¥
			inScope, _ := s.advancedScope.InScope(link)
			if inScope {
				// è§„èŒƒåŒ–URL
				normalizedURL, err := s.paramHandler.NormalizeURL(link)
				if err == nil {
					allLinks[normalizedURL] = true
				} else {
					allLinks[link] = true
				}
			} else {
				if parsedURL.Host != s.targetDomain && parsedURL.Host != "" {
					externalLinks = append(externalLinks, link)
				}
			}
		}
	}
	s.mutex.Unlock()

	// è®°å½•å¤–éƒ¨é“¾æ¥
	if len(externalLinks) > 0 {
		s.mutex.Lock()
		s.externalLinks = append(s.externalLinks, externalLinks...)
		s.mutex.Unlock()
		fmt.Printf("  å‘ç° %d ä¸ªå¤–éƒ¨é“¾æ¥ï¼ˆå·²è®°å½•ä½†ä¸çˆ¬å–ï¼‰\n", len(externalLinks))
	}

	// è½¬æ¢ä¸ºåˆ—è¡¨å¹¶ä¼˜å…ˆçº§æ’åº
	tasksToSubmit := make([]string, 0)
	skippedBySmart := 0 // ç»Ÿè®¡æ™ºèƒ½å»é‡è·³è¿‡çš„æ•°é‡
	skippedByBusiness := 0 // ç»Ÿè®¡ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤å™¨è·³è¿‡çš„æ•°é‡
	skippedByPattern := 0 // ç»Ÿè®¡URLæ¨¡å¼å»é‡è·³è¿‡çš„æ•°é‡
	skippedByResourceType := 0 // ğŸ†• ç»Ÿè®¡èµ„æºåˆ†ç±»è·³è¿‡çš„æ•°é‡ï¼ˆé™æ€èµ„æº/åŸŸå¤–ï¼‰
	skippedByLoginWall := 0 // ğŸ†• v3.2 ç»Ÿè®¡ç™»å½•å¢™è·³è¿‡çš„æ•°é‡
	
	for link := range allLinks {
		// ğŸ†• v3.2: ç™»å½•å¢™æ£€æµ‹ - è·³è¿‡é‡å¤çš„ç™»å½•é¡µé¢å˜ä½“
		if s.loginWallDetector != nil {
			shouldSkip, reason := s.loginWallDetector.ShouldSkipURL(link)
			if shouldSkip {
				skippedByLoginWall++
				if skippedByLoginWall <= 3 {
					s.logger.Debug("ç™»å½•å¢™è¿‡æ»¤",
						"url", link,
						"reason", reason)
				}
				continue
			}
		}
		
		// ğŸ†• v3.1: ä½¿ç”¨exclude_extensionsåˆ¤æ–­æ˜¯å¦éœ€è¦è¯·æ±‚
		// JS/CSSæ–‡ä»¶å§‹ç»ˆè¯·æ±‚ï¼Œå…¶ä»–è¢«æ’é™¤çš„æ‰©å±•ååªè®°å½•ä¸è¯·æ±‚
		if s.scopeController != nil {
			shouldRequest, reason := s.scopeController.ShouldRequestURL(link)
			if !shouldRequest {
				skippedByResourceType++
				if skippedByResourceType <= 5 {
					s.logger.Debug("æ‰©å±•åè¿‡æ»¤ï¼šåªè®°å½•ä¸è¯·æ±‚",
						"url", link,
						"reason", reason)
				}
				// URLå·²è¢«è®°å½•ï¼ˆåœ¨addResultä¸­ï¼‰ï¼Œè¿™é‡Œåªæ˜¯è·³è¿‡HTTPè¯·æ±‚
				continue
			}
		}
		
		// v2.9: URLæ¨¡å¼å»é‡æ£€æŸ¥
		shouldProcess, _, reason := s.urlPatternDedup.ShouldProcess(link, "GET")
		if !shouldProcess {
			skippedByPattern++
			if skippedByPattern <= 3 { // åªæ‰“å°å‰3ä¸ªï¼Œé¿å…æ—¥å¿—è¿‡å¤š
				s.logger.Debug("URLæ¨¡å¼å»é‡è·³è¿‡",
					"url", link,
					"reason", reason)
			}
			continue
		}
		
		// å»é‡æ£€æŸ¥
		if s.duplicateHandler.IsDuplicateURL(link) {
			continue
		}

		// v2.6.1: æ™ºèƒ½å‚æ•°å€¼å»é‡æ£€æŸ¥
		if s.config.DeduplicationSettings.EnableSmartParamDedup {
			shouldCrawl, reason := s.smartParamDedup.ShouldCrawl(link)
			if !shouldCrawl {
				skippedBySmart++
				if skippedBySmart <= 5 { // åªæ‰“å°å‰5ä¸ªï¼Œé¿å…æ—¥å¿—è¿‡å¤š
					fmt.Printf("  [æ™ºèƒ½å»é‡] è·³è¿‡: %s\n  åŸå› : %s\n", link, reason)
				}
				continue
			}
		}

		// v2.7: ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤æ£€æŸ¥
		if s.config.DeduplicationSettings.EnableBusinessAwareFilter {
			shouldCrawl, reason, score := s.businessFilter.ShouldCrawlURL(link)
			if !shouldCrawl {
				skippedByBusiness++
				if skippedByBusiness <= 5 { // åªæ‰“å°å‰5ä¸ªï¼Œé¿å…æ—¥å¿—è¿‡å¤š
					s.logger.Debug("ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤è·³è¿‡URL",
						"url", link,
						"reason", reason,
						"score", score)
				}
				continue
			}
			// è®°å½•é«˜ä»·å€¼URL
			if score >= s.config.DeduplicationSettings.BusinessFilterHighValueThreshold {
				s.logger.Info("å‘ç°é«˜ä»·å€¼URL",
					"url", link,
					"score", score,
					"reason", reason)
			}
		}

		// éªŒè¯æ ¼å¼
		if !IsValidURL(link) {
			continue
		}

		tasksToSubmit = append(tasksToSubmit, link)

		// æ¯å±‚é™åˆ¶100ä¸ªURL
		if len(tasksToSubmit) >= 100 {
			break
		}
	}

	// v2.6.1: æ‰“å°æ™ºèƒ½å»é‡ç»Ÿè®¡
	if skippedBySmart > 0 {
		fmt.Printf("  [æ™ºèƒ½å»é‡] æœ¬å±‚è·³è¿‡ %d ä¸ªç›¸ä¼¼å‚æ•°å€¼URL\n", skippedBySmart)
	}
	
	// v2.7: æ‰“å°ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤ç»Ÿè®¡
	if skippedByBusiness > 0 {
		fmt.Printf("  [ä¸šåŠ¡æ„ŸçŸ¥] æœ¬å±‚è¿‡æ»¤ %d ä¸ªä½ä»·å€¼URL\n", skippedByBusiness)
	}
	
	// v2.9: æ‰“å°URLæ¨¡å¼å»é‡ç»Ÿè®¡
	if skippedByPattern > 0 {
		fmt.Printf("  [URLæ¨¡å¼å»é‡] æœ¬å±‚è·³è¿‡ %d ä¸ªé‡å¤æ¨¡å¼URL\n", skippedByPattern)
	}
	
	// ğŸ†• v3.1: æ‰“å°æ‰©å±•åè¿‡æ»¤ç»Ÿè®¡
	if skippedByResourceType > 0 {
		fmt.Printf("  [æ‰©å±•åè¿‡æ»¤] æœ¬å±‚è·³è¿‡ %d ä¸ªé™æ€èµ„æºURLï¼ˆå·²è®°å½•ä¸è¯·æ±‚ï¼ŒJS/CSSé™¤å¤–ï¼‰\n", skippedByResourceType)
	}
	
	// ğŸ†• v3.2: æ‰“å°ç™»å½•å¢™è¿‡æ»¤ç»Ÿè®¡
	if skippedByLoginWall > 0 {
		fmt.Printf("  [ç™»å½•å¢™è¿‡æ»¤] æœ¬å±‚è·³è¿‡ %d ä¸ªé‡å¤çš„ç™»å½•é¡µé¢å˜ä½“\n", skippedByLoginWall)
	}

	// ä¼˜å…ˆçº§æ’åºï¼ˆğŸ†• ä¼ å…¥å®é™…æ·±åº¦ï¼Œç”¨äºç²¾ç¡®ä¼˜å…ˆçº§è®¡ç®—ï¼‰
	tasksToSubmit = s.prioritizeURLsWithDepth(tasksToSubmit, targetDepth)

	return tasksToSubmit
}

// prioritizeURLsWithDepth å¸¦æ·±åº¦å‚æ•°çš„ä¼˜å…ˆçº§æ’åº
func (s *Spider) prioritizeURLsWithDepth(urls []string, depth int) []string {
	// å¦‚æœæœ‰ä¼˜å…ˆçº§è°ƒåº¦å™¨ï¼Œä½¿ç”¨ç²¾ç¡®è®¡ç®—ï¼ˆæ··åˆå†³ç­–æ¨¡å¼ï¼‰
	if s.priorityScheduler != nil {
		return s.prioritizeURLsWithPreciseCalculation(urls, depth)
	}
	
	// å¦åˆ™ä½¿ç”¨ç®€å•åˆ†ç±»
	return s.prioritizeURLs(urls)
}

// crawlLayer çˆ¬å–ä¸€å±‚çš„æ‰€æœ‰é“¾æ¥
func (s *Spider) crawlLayer(links []string, depth int) []*Result {
	results := make([]*Result, 0)

	// æ ‡è®°ä¸ºå·²è®¿é—®
	s.mutex.Lock()
	for _, link := range links {
		s.visitedURLs[link] = true
	}
	s.mutex.Unlock()

	// ä¸ºæ¯å±‚åˆ›å»ºæ–°çš„å·¥ä½œæ± ï¼ˆä¿®å¤ï¼šé¿å…å¤ç”¨å·²å…³é—­çš„å·¥ä½œæ± ï¼‰
	layerWorkerPool := NewWorkerPool(30, 20)

	// å¯åŠ¨å·¥ä½œæ± 
	layerWorkerPool.Start(func(task Task) (*Result, error) {
		return s.crawlURL(task.URL)
	})

	// æäº¤æ‰€æœ‰ä»»åŠ¡
	for _, link := range links {
		task := Task{
			URL:   link,
			Depth: depth,
		}
		if err := layerWorkerPool.Submit(task); err != nil {
			fmt.Printf("  æäº¤ä»»åŠ¡å¤±è´¥ %s: %v\n", link, err)
		}
	}

	// ç­‰å¾…å®Œæˆï¼ˆä¸æ˜¾ç¤ºè¿›åº¦ï¼Œé¿å…å¹²æ‰°ï¼‰
	layerWorkerPool.Wait()

	// æ”¶é›†ç»“æœ
	results = layerWorkerPool.GetResults()

	// åœæ­¢å·¥ä½œæ± 
	layerWorkerPool.Stop()

	// æ˜¾ç¤ºç»Ÿè®¡
	stats := layerWorkerPool.GetStats()
	fmt.Printf("  æœ¬å±‚ç»Ÿè®¡ - æ€»ä»»åŠ¡: %d, æˆåŠŸ: %d, å¤±è´¥: %d\n",
		stats["total"], stats["completed"]-stats["failed"], stats["failed"])

	return results
}

// crawlURL çˆ¬å–å•ä¸ªURLï¼ˆä¾›å·¥ä½œæ± ä½¿ç”¨ï¼‰
func (s *Spider) crawlURL(targetURL string) (*Result, error) {
	// è§£æURL
	parsedURL, err := url.Parse(targetURL)
	if err != nil {
		return nil, fmt.Errorf("URLè§£æå¤±è´¥: %v", err)
	}

	// ä½¿ç”¨é™æ€çˆ¬è™«
	result, err := s.staticCrawler.Crawl(parsedURL)
	if err != nil {
		// å¦‚æœé™æ€çˆ¬è™«å¤±è´¥ï¼Œå°è¯•åŠ¨æ€çˆ¬è™«
		if s.config.StrategySettings.EnableDynamicCrawler {
			result, err = s.dynamicCrawler.Crawl(parsedURL)
			if err != nil {
				return nil, fmt.Errorf("çˆ¬å–å¤±è´¥: %v", err)
			}
		} else {
			return nil, fmt.Errorf("é™æ€çˆ¬è™«å¤±è´¥: %v", err)
		}
	}

	return result, nil
}

// showProgress æ˜¾ç¤ºçˆ¬å–è¿›åº¦
func (s *Spider) showProgress() {
	ticker := time.NewTicker(2 * time.Second)
	defer ticker.Stop()

	for {
		select {
		case <-ticker.C:
			progress := s.workerPool.GetProgress()
			stats := s.workerPool.GetStats()

			// è®¡ç®—è¿›åº¦æ¡
			barWidth := 30
			filled := int(progress * float64(barWidth) / 100)
			bar := strings.Repeat("â–ˆ", filled) + strings.Repeat("â–‘", barWidth-filled)

			fmt.Printf("\r[è¿›åº¦] %s %.1f%% (%d/%d)", bar, progress, stats["completed"], stats["total"])

			if stats["completed"] >= stats["total"] {
				fmt.Println()
				return
			}
		}
	}
}

// ImportFromBurp ä»Burp Suiteæ–‡ä»¶å¯¼å…¥
func (s *Spider) ImportFromBurp(filename string) error {
	fmt.Printf("ä»Burp Suiteå¯¼å…¥æµé‡: %s\n", filename)

	// åˆ›å»ºè¢«åŠ¨çˆ¬å–å™¨
	s.passiveCrawler = NewPassiveCrawler("burp")

	// åŠ è½½Burpæ–‡ä»¶
	err := s.passiveCrawler.LoadFromBurp(filename)
	if err != nil {
		return err
	}

	// è¿‡æ»¤ç›®æ ‡åŸŸåçš„URL
	targetURLs := s.passiveCrawler.FilterByDomain(s.targetDomain)
	fmt.Printf("è¿‡æ»¤åå¾—åˆ°ç›®æ ‡åŸŸåURL: %dä¸ª\n", len(targetURLs))

	// å°†å¯¼å…¥çš„URLå’Œè¡¨å•åŠ å…¥ç»“æœ
	passiveResult := s.passiveCrawler.ExportToResult(s.targetDomain)
	s.addResult(passiveResult)

	return nil
}

// ImportFromHAR ä»HARæ–‡ä»¶å¯¼å…¥
func (s *Spider) ImportFromHAR(filename string) error {
	fmt.Printf("ä»HARæ–‡ä»¶å¯¼å…¥æµé‡: %s\n", filename)

	// åˆ›å»ºè¢«åŠ¨çˆ¬å–å™¨
	s.passiveCrawler = NewPassiveCrawler("har")

	// åŠ è½½HARæ–‡ä»¶
	err := s.passiveCrawler.LoadFromHAR(filename)
	if err != nil {
		return err
	}

	// è¿‡æ»¤ç›®æ ‡åŸŸåçš„URL
	targetURLs := s.passiveCrawler.FilterByDomain(s.targetDomain)
	fmt.Printf("è¿‡æ»¤åå¾—åˆ°ç›®æ ‡åŸŸåURL: %dä¸ª\n", len(targetURLs))

	// å°†å¯¼å…¥çš„URLå’Œè¡¨å•åŠ å…¥ç»“æœ
	passiveResult := s.passiveCrawler.ExportToResult(s.targetDomain)
	s.addResult(passiveResult)

	return nil
}

// Stop åœæ­¢çˆ¬å–
func (s *Spider) Stop() {
	fmt.Println("åœæ­¢çˆ¬å–...")
	s.staticCrawler.Stop()
	s.dynamicCrawler.Stop()

	// å…³é—­æ€§èƒ½ä¼˜åŒ–å™¨
	if s.perfOptimizer != nil {
		s.perfOptimizer.Close()
	}
}

// Close ä¼˜é›…å…³é—­çˆ¬è™«ï¼Œé‡Šæ”¾æ‰€æœ‰èµ„æºï¼ˆå®ç° io.Closer æ¥å£ï¼‰
func (s *Spider) Close() error {
	s.closeMux.Lock()
	defer s.closeMux.Unlock()

	// é˜²æ­¢é‡å¤å…³é—­
	if s.closed {
		return nil
	}

	fmt.Println("\næ­£åœ¨å…³é—­çˆ¬è™«ï¼Œæ¸…ç†èµ„æº...")

	// åœæ­¢çˆ¬å–
	s.Stop()

	// ç­‰å¾…æ‰€æœ‰ goroutine å®Œæˆ
	s.wg.Wait()

	// å…³é—­ done channel
	close(s.done)

	// æ ‡è®°ä¸ºå·²å…³é—­
	s.closed = true

	fmt.Println("èµ„æºæ¸…ç†å®Œæˆ")
	return nil
}

// cleanup å†…éƒ¨æ¸…ç†æ–¹æ³•ï¼ˆåœ¨ Start ä¸­ä½¿ç”¨ defer è°ƒç”¨ï¼‰
func (s *Spider) cleanup() {
	// Close æ–¹æ³•å·²ç»å¤„ç†äº†æ‰€æœ‰æ¸…ç†å·¥ä½œ
	s.Close()
}

// prioritizeURLs URLä¼˜å…ˆçº§æ’åºï¼ˆv2.8å¢å¼ºï¼šBFS + ä¼˜å…ˆçº§æ··åˆå†³ç­–ï¼‰
func (s *Spider) prioritizeURLs(urls []string) []string {
	// ğŸ†• v2.8æ··åˆå†³ç­–ï¼šå¦‚æœæœ‰ä¼˜å…ˆçº§è°ƒåº¦å™¨ï¼Œä½¿ç”¨ç²¾ç¡®ä¼˜å…ˆçº§è®¡ç®—
	if s.priorityScheduler != nil {
		return s.prioritizeURLsWithPreciseCalculation(urls, 2) // depthé»˜è®¤2ï¼ˆä¼šåœ¨è°ƒç”¨å¤„ä¼ å…¥å®é™…æ·±åº¦ï¼‰
	}
	
	// å‘ä¸‹å…¼å®¹ï¼šä½¿ç”¨åŸæœ‰çš„ç®€å•ä¸‰çº§åˆ†ç±»
	highPriority := make([]string, 0)   // é«˜ä¼˜å…ˆçº§
	mediumPriority := make([]string, 0) // ä¸­ä¼˜å…ˆçº§
	lowPriority := make([]string, 0)    // ä½ä¼˜å…ˆçº§

	for _, url := range urls {
		urlLower := strings.ToLower(url)

		// é«˜ä¼˜å…ˆçº§ï¼šå¸¦å¤šä¸ªå‚æ•°çš„URLã€admin/api/loginç­‰æ•æ„Ÿè·¯å¾„
		if (strings.Count(url, "=") >= 2) ||
			strings.Contains(urlLower, "/admin") ||
			strings.Contains(urlLower, "/api/") ||
			strings.Contains(urlLower, "/login") ||
			strings.Contains(urlLower, "/user") ||
			strings.Contains(urlLower, "/account") {
			highPriority = append(highPriority, url)
		} else if strings.Contains(url, "?") {
			// ä¸­ä¼˜å…ˆçº§ï¼šå¸¦å‚æ•°çš„URL
			mediumPriority = append(mediumPriority, url)
		} else {
			// ä½ä¼˜å…ˆçº§ï¼šæ™®é€šURL
			lowPriority = append(lowPriority, url)
		}
	}

	// åˆå¹¶ï¼šé«˜ â†’ ä¸­ â†’ ä½
	result := make([]string, 0, len(urls))
	result = append(result, highPriority...)
	result = append(result, mediumPriority...)
	result = append(result, lowPriority...)

	return result
}

// prioritizeURLsWithPreciseCalculation ğŸ†• ä½¿ç”¨ç²¾ç¡®ä¼˜å…ˆçº§è®¡ç®—æ’åºï¼ˆæ··åˆå†³ç­–æ ¸å¿ƒï¼‰
func (s *Spider) prioritizeURLsWithPreciseCalculation(urls []string, depth int) []string {
	type URLWithPriority struct {
		URL      string
		Priority float64
	}
	
	urlsWithPriority := make([]URLWithPriority, 0, len(urls))
	
	// è®¡ç®—æ¯ä¸ªURLçš„ç²¾ç¡®ä¼˜å…ˆçº§
	for _, url := range urls {
		priority := s.priorityScheduler.CalculatePriority(url, depth)
		urlsWithPriority = append(urlsWithPriority, URLWithPriority{
			URL:      url,
			Priority: priority,
		})
	}
	
	// æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åº
	sort.Slice(urlsWithPriority, func(i, j int) bool {
		return urlsWithPriority[i].Priority > urlsWithPriority[j].Priority
	})
	
	// æ‰“å°æœ¬å±‚ä¼˜å…ˆçº§TOP3ï¼ˆè®©ç”¨æˆ·çœ‹åˆ°æ··åˆå†³ç­–çš„æ•ˆæœï¼‰
	if len(urlsWithPriority) > 0 {
		fmt.Printf("\n  [æ··åˆå†³ç­–] æœ¬å±‚ä¼˜å…ˆçº§TOP3ï¼ˆBFSæ¡†æ¶ + æ™ºèƒ½æ’åºï¼‰:\n")
		topCount := 3
		if len(urlsWithPriority) < 3 {
			topCount = len(urlsWithPriority)
		}
		for i := 0; i < topCount; i++ {
			fmt.Printf("    %d. [ä¼˜å…ˆçº§:%.2f] %s\n", 
				i+1, urlsWithPriority[i].Priority, urlsWithPriority[i].URL)
		}
		
		if len(urlsWithPriority) > 3 {
			fmt.Printf("    ... è¿˜æœ‰ %d ä¸ªURLæŒ‰ä¼˜å…ˆçº§æ’åº\n", len(urlsWithPriority)-3)
		}
	}
	
	// æå–æ’åºåçš„URLåˆ—è¡¨
	result := make([]string, 0, len(urls))
	for _, item := range urlsWithPriority {
		result = append(result, item.URL)
	}
	
	return result
}

// isRelativeURL æ£€æŸ¥æ˜¯å¦ä¸ºç›¸å¯¹URLï¼ˆç”¨äºCDN JSä¸­çš„URLæ‹¼æ¥ï¼‰
func isRelativeURL(urlStr string) bool {
	// å®Œæ•´URLï¼ˆhttp://æˆ–https://ï¼‰ä¸æ˜¯ç›¸å¯¹URL
	if strings.HasPrefix(urlStr, "http://") || strings.HasPrefix(urlStr, "https://") {
		return false
	}
	
	// åè®®ç›¸å¯¹URLï¼ˆ//example.comï¼‰ä¸æ˜¯ç›¸å¯¹URL
	if strings.HasPrefix(urlStr, "//") {
		return false
	}
	
	// ä»¥ä¸‹æƒ…å†µè§†ä¸ºç›¸å¯¹URLï¼š
	// - ä»¥/å¼€å¤´ï¼ˆç»å¯¹è·¯å¾„ï¼‰: /api/user
	// - ä»¥./å¼€å¤´ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰: ./assets/app.js
	// - ä»¥../å¼€å¤´ï¼ˆä¸Šçº§è·¯å¾„ï¼‰: ../config.json
	// - ä¸å«://ä½†å«è·¯å¾„åˆ†éš”ç¬¦: api/endpoint
	return strings.HasPrefix(urlStr, "/") || 
	       strings.HasPrefix(urlStr, "./") || 
	       strings.HasPrefix(urlStr, "../") ||
	       (strings.Contains(urlStr, "/") && !strings.Contains(urlStr, "://"))
}

// IsValidURL æ£€æŸ¥URLæ˜¯å¦ä¸ºæœ‰æ•ˆçš„HTTP/HTTPSé“¾æ¥
func IsValidURL(url string) bool {
	// æ£€æŸ¥æ˜¯å¦ä¸ºç©º
	if url == "" {
		return false
	}
	
	// è¿‡æ»¤æ˜æ˜¾æ— æ•ˆçš„å­—ç¬¦ä¸²ï¼ˆé•¿åº¦æ£€æŸ¥ï¼‰
	if len(url) < 2 || len(url) > 2048 {
		return false
	}

	// æ£€æŸ¥æ˜¯å¦ä¸ºjavascript:æˆ–mailto:ç­‰éHTTPé“¾æ¥
	if strings.HasPrefix(url, "javascript:") ||
		strings.HasPrefix(url, "mailto:") ||
		strings.HasPrefix(url, "tel:") ||
		strings.HasPrefix(url, "sms:") ||
		strings.HasPrefix(url, "ftp:") ||
		strings.HasPrefix(url, "file:") ||
		strings.HasPrefix(url, "data:") {
		return false
	}

	// æ£€æŸ¥æ˜¯å¦ä¸ºHTTP/HTTPSåè®®ï¼ˆå®Œæ•´URLï¼‰
	if strings.HasPrefix(url, "http://") || strings.HasPrefix(url, "https://") {
		return true
	}
	
	// æ£€æŸ¥æ˜¯å¦ä¸º//å¼€å¤´çš„åè®®ç›¸å¯¹URL
	if strings.HasPrefix(url, "//") {
		return true
	}

	// å¯¹äºç›¸å¯¹URLï¼Œéœ€è¦æ›´ä¸¥æ ¼çš„éªŒè¯
	if !strings.Contains(url, "://") {
		// æ’é™¤æ˜æ˜¾ä¸æ˜¯URLçš„å­—ç¬¦ä¸²
		
		// 1. ä¸åŒ…å«ç©ºæ ¼ï¼ˆé™¤éæ˜¯ç¼–ç åçš„%20ï¼‰
		if strings.Contains(url, " ") && !strings.Contains(url, "%20") {
			return false
		}
		
		// 2. ä¸èƒ½åªæ˜¯å•ä¸ªå•è¯ï¼ˆæ²¡æœ‰è·¯å¾„åˆ†éš”ç¬¦ï¼‰
		// å…è®¸ï¼š/path, /api/endpoint, ../relative, ./file
		// æ‹’ç»ï¼šword, emoji_name, keyword
		if !strings.Contains(url, "/") && !strings.Contains(url, "?") && !strings.Contains(url, "#") {
			// å•ä¸ªå•è¯ï¼Œå¾ˆå¯èƒ½æ˜¯æ— æ•ˆçš„
			// ä½†è¦å…è®¸ index.html è¿™æ ·çš„æ–‡ä»¶å
			if !strings.Contains(url, ".") {
				return false
			}
		}
		
		// 3. æ’é™¤å¸¸è§çš„éURLæ¨¡å¼
		// - emojiåç§°ï¼ˆåŒ…å«ä¸‹åˆ’çº¿ä½†æ²¡æœ‰è·¯å¾„ï¼‰
		// - HTMLå±æ€§ï¼ˆaria-*, data-*ï¼‰
		// - CSSç±»å
		if !strings.HasPrefix(url, "/") && !strings.HasPrefix(url, ".") && !strings.HasPrefix(url, "?") {
			// æ£€æŸ¥æ˜¯å¦çœ‹èµ·æ¥åƒemojiæˆ–å±æ€§å
			if strings.Contains(url, "_") && !strings.Contains(url, "/") && !strings.Contains(url, "=") {
				// å¯èƒ½æ˜¯ emoji_name æ ¼å¼
				return false
			}
			if strings.HasPrefix(url, "aria-") || strings.HasPrefix(url, "data-") {
				return false
			}
		}
		
		// 4. ç›¸å¯¹URLå¿…é¡»ä»¥ / . ? # å¼€å¤´ï¼Œæˆ–è€…çœ‹èµ·æ¥åƒæ–‡ä»¶è·¯å¾„
		firstChar := url[0]
		if firstChar != '/' && firstChar != '.' && firstChar != '?' && firstChar != '#' {
			// ä¸ä»¥è¿™äº›å­—ç¬¦å¼€å¤´çš„ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«è·¯å¾„åˆ†éš”ç¬¦
			if !strings.Contains(url, "/") {
				return false
			}
		}
		
		return true
	}

	// å…¶ä»–æƒ…å†µè§†ä¸ºæ— æ•ˆ
	return false
}

// ExportResults å¯¼å‡ºç»“æœ
func (s *Spider) ExportResults() map[string]interface{} {
	s.mutex.Lock()
	defer s.mutex.Unlock()

	exportData := make(map[string]interface{})
	exportData["total_results"] = len(s.results)

	// ç»Ÿè®¡ä¿¡æ¯
	totalLinks := 0
	totalAssets := 0
	totalForms := 0
	totalAPIs := 0

	// è¯¦ç»†ç»“æœæ•°æ®
	detailedResults := make([]map[string]interface{}, 0)
	allLinks := make([]string, 0)
	allAPIs := make([]string, 0)

	// ä½¿ç”¨æ™ºèƒ½å»é‡å¤„ç†æ‰€æœ‰URLå’Œè¡¨å•
	for _, result := range s.results {
		totalLinks += len(result.Links)
		totalAssets += len(result.Assets)
		totalForms += len(result.Forms)
		totalAPIs += len(result.APIs)

		// ä¿å­˜è¯¦ç»†ç»“æœ
		resultData := make(map[string]interface{})
		resultData["url"] = result.URL
		resultData["status_code"] = result.StatusCode
		resultData["content_type"] = result.ContentType
		resultData["links"] = result.Links
		resultData["assets"] = result.Assets
		resultData["forms"] = result.Forms
		resultData["apis"] = result.APIs
		resultData["post_requests"] = result.POSTRequests // æ·»åŠ POSTè¯·æ±‚æ•°æ®
		detailedResults = append(detailedResults, resultData)

		// å¤„ç†é“¾æ¥è¿›è¡Œæ™ºèƒ½å»é‡
		for _, link := range result.Links {
			s.smartDeduplication.ProcessURL(link)
		}

		// å¤„ç†è¡¨å•è¿›è¡Œæ™ºèƒ½å»é‡
		for _, form := range result.Forms {
			s.smartDeduplication.ProcessForm(form)
		}

		// æ”¶é›†æ‰€æœ‰é“¾æ¥
		allLinks = append(allLinks, result.Links...)
		allAPIs = append(allAPIs, result.APIs...)
	}

	exportData["total_links"] = totalLinks
	exportData["total_assets"] = totalAssets
	exportData["total_forms"] = totalForms
	exportData["total_apis"] = totalAPIs
	exportData["detailed_results"] = detailedResults
	exportData["links"] = allLinks
	exportData["apis"] = allAPIs
	exportData["external_links"] = s.externalLinks
	exportData["hidden_paths"] = s.hiddenPaths
	exportData["security_findings"] = s.securityFindings
	exportData["cross_domain_js_urls"] = s.crossDomainJS
	exportData["total_hidden_paths"] = len(s.hiddenPaths)
	exportData["total_security_findings"] = len(s.securityFindings)
	exportData["total_cross_domain_js_urls"] = len(s.crossDomainJS)

	// æ·»åŠ æ™ºèƒ½å»é‡ç»Ÿè®¡
	exportData["deduplication_stats"] = s.smartDeduplication.GetDeduplicationStats()
	exportData["unique_url_patterns"] = s.smartDeduplication.GetUniqueURLs()
	exportData["unique_form_patterns"] = s.smartDeduplication.GetUniqueForms()

	// æ·»åŠ æ–°åŠŸèƒ½ç»Ÿè®¡
	if s.advancedScope != nil {
		exportData["scope_stats"] = s.advancedScope.GetStatistics()
	}
	if s.perfOptimizer != nil {
		exportData["performance_stats"] = s.perfOptimizer.GetStatistics()
	}
	if s.formFiller != nil {
		exportData["form_filler_stats"] = s.formFiller.GetStatistics()
	}

	// æ·»åŠ é«˜çº§åŠŸèƒ½ç»Ÿè®¡
	exportData["detected_technologies"] = s.detectedTechs
	exportData["tech_stack_summary"] = s.techDetector.GetTechStackSummary(s.detectedTechs)
	exportData["sensitive_findings"] = s.sensitiveFindings
	exportData["sensitive_stats"] = s.sensitiveDetector.GetStatistics()
	exportData["total_sensitive_findings"] = len(s.sensitiveFindings)

	// è¢«åŠ¨çˆ¬å–ç»Ÿè®¡ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
	if s.passiveCrawler != nil {
		exportData["passive_stats"] = s.passiveCrawler.GetStatistics()
	}

	// å­åŸŸåæå–ç»Ÿè®¡
	if s.subdomainExtractor != nil {
		exportData["subdomains"] = s.subdomainExtractor.ExportSubdomains()
		exportData["subdomain_stats"] = s.subdomainExtractor.GetStatistics()
		exportData["total_subdomains"] = s.subdomainExtractor.GetSubdomainCount()
	}

	// DOMç›¸ä¼¼åº¦æ£€æµ‹ç»Ÿè®¡
	if s.domSimilarity != nil {
		exportData["dom_similarity_stats"] = s.domSimilarity.GetStatistics()
		exportData["similar_pages"] = s.domSimilarity.GetSimilarPages()
		exportData["total_similar_pages"] = len(s.domSimilarity.GetSimilarPages())
	}

	// Sitemapå’Œrobots.txtç»Ÿè®¡
	exportData["sitemap_urls"] = s.sitemapURLs
	exportData["robots_urls"] = s.robotsURLs
	exportData["total_sitemap_urls"] = len(s.sitemapURLs)
	exportData["total_robots_urls"] = len(s.robotsURLs)

	// === æ–°å¢ï¼šé™æ€èµ„æºåˆ†ç±» ===
	allAssets := make([]string, 0)
	for _, result := range s.results {
		allAssets = append(allAssets, result.Assets...)
	}

	if s.assetClassifier != nil {
		classifiedAssets := s.assetClassifier.ClassifyAssets(allAssets)
		exportData["classified_assets"] = classifiedAssets
		exportData["assets_stats"] = s.assetClassifier.GetAssetStats(classifiedAssets)
	}

	// === æ–°å¢ï¼šIPé“¾æ¥åˆ†ç±» ===
	// é‡ç½®allLinksç”¨äºIPæ£€æµ‹ï¼ˆåŒ…å«æ‰€æœ‰é“¾æ¥æºï¼‰
	allLinks = make([]string, 0)
	for _, result := range s.results {
		allLinks = append(allLinks, result.Links...)
	}
	// ä¹Ÿæ£€æŸ¥å¤–éƒ¨é“¾æ¥å’Œå…¶ä»–é“¾æ¥æº
	allLinks = append(allLinks, s.externalLinks...)
	allLinks = append(allLinks, s.crossDomainJS...)

	if s.ipDetector != nil {
		classifiedIPs := s.ipDetector.ClassifyIPLinks(allLinks)
		exportData["ip_links"] = map[string]interface{}{
			"private_ips":   classifiedIPs["private_ip"],
			"public_ips":    classifiedIPs["public_ip"],
			"private_count": len(classifiedIPs["private_ip"]),
			"public_count":  len(classifiedIPs["public_ip"]),
			"total_count":   len(classifiedIPs["private_ip"]) + len(classifiedIPs["public_ip"]),
			"has_leak":      len(classifiedIPs["private_ip"]) > 0,
		}
	}

	// v2.7: ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤å™¨ç»Ÿè®¡
	if s.businessFilter != nil && s.config.DeduplicationSettings.EnableBusinessAwareFilter {
		exportData["business_filter_stats"] = s.businessFilter.GetStatistics()
		exportData["business_top_patterns"] = s.businessFilter.GetTopPatterns(20)
	}
	
	// ğŸ†• v2.8: URLå»é‡ç»Ÿè®¡
	if s.urlDeduplicator != nil {
		exportData["url_deduplication"] = s.urlDeduplicator.GetStatistics()
		exportData["unique_url_patterns"] = s.urlDeduplicator.GetUniquePatterns()
		exportData["all_urls_with_variants"] = s.urlDeduplicator.GetAllURLs()
	}

	return exportData
}

// SaveUniqueURLsToFile ä¿å­˜å»é‡åçš„URLåˆ°æ–‡ä»¶ï¼ˆç»™å…¶ä»–å·¥å…·ä½¿ç”¨ï¼‰
func (s *Spider) SaveUniqueURLsToFile(filepath string) error {
	if s.urlDeduplicator == nil {
		return fmt.Errorf("URLå»é‡å™¨æœªåˆå§‹åŒ–")
	}
	
	s.mutex.Lock()
	defer s.mutex.Unlock()
	
	// è·å–å”¯ä¸€çš„URLæ¨¡å¼
	uniquePatterns := s.urlDeduplicator.GetUniquePatterns()
	
	if len(uniquePatterns) == 0 {
		return fmt.Errorf("æ²¡æœ‰URLå¯ä¿å­˜")
	}
	
	// åˆ›å»ºæ–‡ä»¶
	file, err := os.Create(filepath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %v", err)
	}
	defer file.Close()
	
	// å†™å…¥URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
	for _, pattern := range uniquePatterns {
		_, err := file.WriteString(pattern + "\n")
		if err != nil {
			return fmt.Errorf("å†™å…¥æ–‡ä»¶å¤±è´¥: %v", err)
		}
	}
	
	// æ‰“å°ç»Ÿè®¡
	stats := s.urlDeduplicator.GetStatistics()
	fmt.Printf("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	fmt.Printf("  âœ… URLå»é‡æ–‡ä»¶å·²ä¿å­˜: %s\n", filepath)
	fmt.Printf("  å”¯ä¸€URLæ¨¡å¼: %d ä¸ª\n", stats["unique_patterns"])
	fmt.Printf("  åŸå§‹URLæ€»æ•°: %d ä¸ª\n", stats["total_urls"])
	if stats["total_urls"] > stats["unique_patterns"] {
		reduction := stats["total_urls"] - stats["unique_patterns"]
		reductionPercent := float64(reduction) / float64(stats["total_urls"]) * 100
		fmt.Printf("  å»é‡æ•ˆæœ: å‡å°‘ %d ä¸ª (%.1f%%)\n", reduction, reductionPercent)
	}
	fmt.Printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
	
	return nil
}

// PrintURLDeduplicationReport æ‰“å°URLå»é‡è¯¦ç»†æŠ¥å‘Š
func (s *Spider) PrintURLDeduplicationReport() {
	if s.urlDeduplicator != nil {
		s.urlDeduplicator.PrintReport()
		// æ˜¾ç¤ºå‰10ä¸ªæœ€å¤šå˜ä½“çš„URLæ¨¡å¼
		s.urlDeduplicator.PrintDetailedReport(10)
	}
}

// PrintBusinessFilterReport æ‰“å°ä¸šåŠ¡æ„ŸçŸ¥è¿‡æ»¤å™¨çš„è¯¦ç»†æŠ¥å‘Š
func (s *Spider) PrintBusinessFilterReport() {
	if s.businessFilter != nil && s.config.DeduplicationSettings.EnableBusinessAwareFilter {
		s.businessFilter.PrintReport()
	}
}

// PrintURLPatternDedupReport æ‰“å°URLæ¨¡å¼å»é‡æŠ¥å‘Š
func (s *Spider) PrintURLPatternDedupReport() {
	if s.urlPatternDedup != nil {
		s.urlPatternDedup.PrintReport()
	}
}

// SaveSensitiveInfoToFile ä¿å­˜æ•æ„Ÿä¿¡æ¯åˆ°æ–‡ä»¶ï¼ˆç‹¬ç«‹è¾“å‡ºï¼ŒåŒ…å«æ¥æºURLï¼‰
func (s *Spider) SaveSensitiveInfoToFile(filepath string) error {
	s.mutex.Lock()
	defer s.mutex.Unlock()
	
	if s.sensitiveDetector == nil {
		return fmt.Errorf("æ•æ„Ÿä¿¡æ¯æ£€æµ‹å™¨æœªåˆå§‹åŒ–")
	}
	
	findings := s.sensitiveDetector.GetFindings()
	if len(findings) == 0 {
		fmt.Println("[æ•æ„Ÿä¿¡æ¯] æœªå‘ç°æ•æ„Ÿä¿¡æ¯ï¼Œè·³è¿‡æ–‡ä»¶ä¿å­˜")
		return nil
	}
	
	// åˆ›å»ºæ–‡ä»¶
	file, err := os.Create(filepath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ•æ„Ÿä¿¡æ¯æ–‡ä»¶å¤±è´¥: %v", err)
	}
	defer file.Close()
	
	// å†™å…¥æ ‡é¢˜
	file.WriteString("==========================================\n")
	file.WriteString("   æ•æ„Ÿä¿¡æ¯æ³„éœ²æ£€æµ‹æŠ¥å‘Š\n")
	file.WriteString("==========================================\n\n")
	
	// ç»Ÿè®¡ä¿¡æ¯
	stats := s.sensitiveDetector.GetStatistics()
	file.WriteString(fmt.Sprintf("æ‰«æé¡µé¢æ•°: %d\n", stats["total_scanned"]))
	file.WriteString(fmt.Sprintf("å‘ç°æ€»æ•°: %d\n", stats["total_findings"]))
	file.WriteString(fmt.Sprintf("  - é«˜å±: %d\n", stats["high_severity"]))
	file.WriteString(fmt.Sprintf("  - ä¸­å±: %d\n", stats["medium_severity"]))
	file.WriteString(fmt.Sprintf("  - ä½å±: %d\n", stats["low_severity"]))
	file.WriteString("\n==========================================\n\n")
	
	// æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç»„
	highFindings := s.sensitiveDetector.GetFindingsBySeverity("HIGH")
	mediumFindings := s.sensitiveDetector.GetFindingsBySeverity("MEDIUM")
	lowFindings := s.sensitiveDetector.GetFindingsBySeverity("LOW")
	
	// å†™å…¥é«˜å±å‘ç°
	if len(highFindings) > 0 {
		file.WriteString("ã€é«˜å±å‘ç°ã€‘\n")
		file.WriteString(strings.Repeat("-", 60) + "\n\n")
		for i, finding := range highFindings {
			file.WriteString(fmt.Sprintf("[%d] %s\n", i+1, finding.Type))
			file.WriteString(fmt.Sprintf("    æ¥æºURL: %s\n", finding.SourceURL))
			file.WriteString(fmt.Sprintf("    ä½ç½®: %s\n", finding.Location))
			file.WriteString(fmt.Sprintf("    å€¼: %s\n", finding.Value))
			file.WriteString("\n")
		}
		file.WriteString("\n")
	}
	
	// å†™å…¥ä¸­å±å‘ç°
	if len(mediumFindings) > 0 {
		file.WriteString("ã€ä¸­å±å‘ç°ã€‘\n")
		file.WriteString(strings.Repeat("-", 60) + "\n\n")
		for i, finding := range mediumFindings {
			file.WriteString(fmt.Sprintf("[%d] %s\n", i+1, finding.Type))
			file.WriteString(fmt.Sprintf("    æ¥æºURL: %s\n", finding.SourceURL))
			file.WriteString(fmt.Sprintf("    ä½ç½®: %s\n", finding.Location))
			file.WriteString(fmt.Sprintf("    å€¼: %s\n", finding.Value))
			file.WriteString("\n")
		}
		file.WriteString("\n")
	}
	
	// å†™å…¥ä½å±å‘ç°
	if len(lowFindings) > 0 {
		file.WriteString("ã€ä½å±å‘ç°ã€‘\n")
		file.WriteString(strings.Repeat("-", 60) + "\n\n")
		
		// æŒ‰ç±»å‹åˆ†ç»„ç»Ÿè®¡ï¼ˆä½å±æ•°é‡å¯èƒ½å¾ˆå¤šï¼Œåªæ˜¾ç¤ºç»Ÿè®¡ï¼‰
		typeCount := make(map[string]int)
		typeExamples := make(map[string]*SensitiveInfo)
		for _, finding := range lowFindings {
			typeCount[finding.Type]++
			if typeExamples[finding.Type] == nil {
				typeExamples[finding.Type] = finding
			}
		}
		
		for findingType, count := range typeCount {
			example := typeExamples[findingType]
			file.WriteString(fmt.Sprintf("ç±»å‹: %s (å…± %d ä¸ª)\n", findingType, count))
			file.WriteString(fmt.Sprintf("  ç¤ºä¾‹æ¥æº: %s\n", example.SourceURL))
			file.WriteString(fmt.Sprintf("  ç¤ºä¾‹å€¼: %s\n", example.Value))
			file.WriteString("\n")
		}
	}
	
	// æ‰“å°ç»Ÿè®¡
	fmt.Printf("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	fmt.Printf("  âœ… æ•æ„Ÿä¿¡æ¯æŠ¥å‘Šå·²ä¿å­˜: %s\n", filepath)
	fmt.Printf("  æ€»å‘ç°: %d ä¸ª (é«˜å±:%d, ä¸­å±:%d, ä½å±:%d)\n", 
		stats["total_findings"], stats["high_severity"], stats["medium_severity"], stats["low_severity"])
	fmt.Printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
	
	return nil
}

// SaveSensitiveInfoToJSON ä¿å­˜æ•æ„Ÿä¿¡æ¯åˆ°JSONæ–‡ä»¶
func (s *Spider) SaveSensitiveInfoToJSON(filepath string) error {
	s.mutex.Lock()
	defer s.mutex.Unlock()
	
	if s.sensitiveDetector == nil {
		return fmt.Errorf("æ•æ„Ÿä¿¡æ¯æ£€æµ‹å™¨æœªåˆå§‹åŒ–")
	}
	
	findings := s.sensitiveDetector.GetFindings()
	if len(findings) == 0 {
		fmt.Println("[æ•æ„Ÿä¿¡æ¯] æœªå‘ç°æ•æ„Ÿä¿¡æ¯ï¼Œè·³è¿‡JSONä¿å­˜")
		return nil
	}
	
	// æ„å»ºJSONæ•°æ®
	report := map[string]interface{}{
		"scan_time": time.Now().Format("2006-01-02 15:04:05"),
		"target_domain": s.targetDomain,
		"statistics": s.sensitiveDetector.GetStatistics(),
		"findings": s.sensitiveDetector.ExportFindings(),
	}
	
	// è½¬æ¢ä¸ºJSON
	data, err := json.MarshalIndent(report, "", "  ")
	if err != nil {
		return fmt.Errorf("JSONç¼–ç å¤±è´¥: %v", err)
	}
	
	// å†™å…¥æ–‡ä»¶
	if err := os.WriteFile(filepath, data, 0644); err != nil {
		return fmt.Errorf("å†™å…¥JSONæ–‡ä»¶å¤±è´¥: %v", err)
	}
	
	stats := s.sensitiveDetector.GetStatistics()
	fmt.Printf("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	fmt.Printf("  âœ… æ•æ„Ÿä¿¡æ¯JSONæŠ¥å‘Šå·²ä¿å­˜: %s\n", filepath)
	fmt.Printf("  æ€»å‘ç°: %d ä¸ª (é«˜å±:%d, ä¸­å±:%d, ä½å±:%d)\n", 
		stats["total_findings"], stats["high_severity"], stats["medium_severity"], stats["low_severity"])
	fmt.Printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
	
	return nil
}

// SaveStructureUniqueURLsToFile ä¿å­˜ç»“æ„åŒ–å»é‡åçš„URLåˆ°æ–‡ä»¶
// è¯¥æ–¹æ³•ä¼šè¯†åˆ«è·¯å¾„å˜é‡ï¼ˆå¦‚ /product-123/ â†’ /product-{num}/ï¼‰å’Œå‚æ•°å€¼å˜åŒ–
// åªä¿å­˜æ¯ä¸ªç»“æ„çš„ä»£è¡¨æ€§URLï¼Œé¿å…ä¿å­˜å¤§é‡ç›¸ä¼¼URL
func (s *Spider) SaveStructureUniqueURLsToFile(filepath string) error {
	if s.urlStructureDedup == nil {
		return fmt.Errorf("URLç»“æ„åŒ–å»é‡å™¨æœªåˆå§‹åŒ–")
	}
	
	s.mutex.Lock()
	defer s.mutex.Unlock()
	
	// è·å–å”¯ä¸€çš„ç»“æ„åŒ–URL
	uniqueStructures := s.urlStructureDedup.GetUniqueStructures()
	
	if len(uniqueStructures) == 0 {
		return fmt.Errorf("æ²¡æœ‰URLå¯ä¿å­˜")
	}
	
	// åˆ›å»ºæ–‡ä»¶
	file, err := os.Create(filepath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %v", err)
	}
	defer file.Close()
	
	// å†™å…¥URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
	for _, url := range uniqueStructures {
		_, err := file.WriteString(url + "\n")
		if err != nil {
			return fmt.Errorf("å†™å…¥æ–‡ä»¶å¤±è´¥: %v", err)
		}
	}
	
	// æ‰“å°ç»Ÿè®¡
	stats := s.urlStructureDedup.GetStatistics()
	fmt.Printf("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	fmt.Printf("  âœ… ç»“æ„åŒ–å»é‡URLæ–‡ä»¶å·²ä¿å­˜: %s\n", filepath)
	fmt.Printf("  å”¯ä¸€URLç»“æ„: %d ä¸ª\n", stats["unique_structures"])
	fmt.Printf("  åŸå§‹URLæ€»æ•°: %d ä¸ª\n", stats["total_urls"])
	if stats["total_urls"] > stats["unique_structures"] {
		reduction := stats["duplicate_urls"]
		reductionPercent := float64(reduction) / float64(stats["total_urls"]) * 100
		fmt.Printf("  å»é‡æ•ˆæœ: å‡å°‘ %d ä¸ª (%.1f%%)\n", reduction, reductionPercent)
	}
	fmt.Printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
	
	return nil
}

// PrintStructureDeduplicationReport æ‰“å°ç»“æ„åŒ–å»é‡è¯¦ç»†æŠ¥å‘Š
func (s *Spider) PrintStructureDeduplicationReport() {
	if s.urlStructureDedup != nil {
		s.urlStructureDedup.PrintReport()
	}
}

// PrintURLFilterReport æ‰“å°URLè¿‡æ»¤ç»Ÿè®¡æŠ¥å‘Šï¼ˆv3.5æ–°å¢ï¼‰
func (s *Spider) PrintURLFilterReport() {
	if s.urlValidator == nil {
		return
	}
	
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ“Š URLè´¨é‡è¿‡æ»¤æŠ¥å‘Š (v3.5)")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	
	// ç»Ÿè®¡æ‰€æœ‰æ”¶é›†çš„URLå’Œè¿‡æ»¤çš„URL
	totalCollected := 0
	totalFiltered := 0
	validURLs := 0
	
	// éå†æ‰€æœ‰ç»“æœç»Ÿè®¡
	for _, result := range s.results {
		totalCollected += len(result.Links)
		for _, link := range result.Links {
			if s.urlValidator.IsValidBusinessURL(link) {
				validURLs++
			}
		}
	}
	
	totalFiltered = totalCollected - validURLs
	filterRate := 0.0
	if totalCollected > 0 {
		filterRate = float64(totalFiltered) / float64(totalCollected) * 100
	}
	
	fmt.Printf("\nğŸ¯ è¿‡æ»¤æ•ˆæœ:\n")
	fmt.Printf("  åŸå§‹æ”¶é›†URL: %d\n", totalCollected)
	fmt.Printf("  æœ‰æ•ˆä¸šåŠ¡URL: %d\n", validURLs)
	fmt.Printf("  è¿‡æ»¤åƒåœ¾URL: %d\n", totalFiltered)
	fmt.Printf("  è¿‡æ»¤ç‡: %.1f%%\n", filterRate)
	
	fmt.Println("\nâœ¨ è¿‡æ»¤è§„åˆ™:")
	fmt.Println("  âœ“ MIMEç±»å‹å­—ç¬¦ä¸²ï¼ˆapplication/vnd.*ï¼‰")
	fmt.Println("  âœ“ JavaScriptå…³é”®å­—ï¼ˆMath, Object, Arrayç­‰ï¼‰")
	fmt.Println("  âœ“ URLç¼–ç çš„ä»£ç ç‰‡æ®µ")
	fmt.Println("  âœ“ æ— æ„ä¹‰çš„å•å­—ç¬¦è·¯å¾„ï¼ˆ/a, /b, /Mç­‰ï¼‰")
	fmt.Println("  âœ“ HTMLæ ‡ç­¾ç‰‡æ®µ")
	fmt.Println("  âœ“ åªä¿ç•™æœ‰ä¸šåŠ¡ä»·å€¼çš„URL")
	
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
}

// PrintPOSTDetectionReport æ‰“å°POSTè¯·æ±‚æ£€æµ‹æŠ¥å‘Šï¼ˆv3.5æ–°å¢ï¼‰
func (s *Spider) PrintPOSTDetectionReport() {
	totalPOST := 0
	uniquePOSTURLs := make(map[string]bool)
	
	// ç»Ÿè®¡POSTè¯·æ±‚
	for _, result := range s.results {
		totalPOST += len(result.POSTRequests)
		for _, post := range result.POSTRequests {
			uniquePOSTURLs[post.URL] = true
		}
	}
	
	if totalPOST == 0 {
		fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		fmt.Println("ğŸ“® POSTè¯·æ±‚æ£€æµ‹æŠ¥å‘Š (v3.5)")
		fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		fmt.Println("\nâš ï¸  æœªæ£€æµ‹åˆ°POSTè¯·æ±‚")
		fmt.Println("\nğŸ’¡ å¯èƒ½åŸå› :")
		fmt.Println("  1. ç½‘ç«™ä½¿ç”¨çº¯AJAXæäº¤ï¼ˆå»ºè®®ä½¿ç”¨åŠ¨æ€çˆ¬è™«ï¼‰")
		fmt.Println("  2. è¡¨å•æ˜¯JavaScriptåŠ¨æ€ç”Ÿæˆçš„")
		fmt.Println("  3. ç½‘ç«™ä¸åŒ…å«è¡¨å•åŠŸèƒ½")
		fmt.Println("\nğŸ’¡ å»ºè®®:")
		fmt.Println("  - ç¡®ä¿å¯ç”¨äº†åŠ¨æ€çˆ¬è™«ï¼ˆenable_dynamic_crawler: trueï¼‰")
		fmt.Println("  - æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networké¢æ¿")
		fmt.Println("  - è€ƒè™‘ä½¿ç”¨ -depth 3 æˆ–æ›´å¤§å€¼è¿›è¡Œæ·±åº¦çˆ¬å–")
		fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
		return
	}
	
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸ“® POSTè¯·æ±‚æ£€æµ‹æŠ¥å‘Š (v3.5)")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	
	fmt.Printf("\nğŸ¯ æ£€æµ‹ç»“æœ:\n")
	fmt.Printf("  æ€»POSTè¯·æ±‚æ•°: %d\n", totalPOST)
	fmt.Printf("  å”¯ä¸€POSTç«¯ç‚¹: %d\n", len(uniquePOSTURLs))
	
	// ç»Ÿè®¡æ¥æºç±»å‹
	sourceTypes := make(map[string]int)
	for _, result := range s.results {
		for _, post := range result.POSTRequests {
			if post.FromForm {
				sourceTypes["HTMLè¡¨å•"]++
			} else {
				sourceTypes["JavaScript/AJAX"]++
			}
		}
	}
	
	if len(sourceTypes) > 0 {
		fmt.Println("\nğŸ“Š æ¥æºåˆ†å¸ƒ:")
		for source, count := range sourceTypes {
			percent := float64(count) / float64(totalPOST) * 100
			fmt.Printf("  - %s: %d (%.1f%%)\n", source, count, percent)
		}
	}
	
	// æ˜¾ç¤ºå‰10ä¸ªPOSTç«¯ç‚¹ç¤ºä¾‹
	if len(uniquePOSTURLs) > 0 {
		fmt.Println("\nğŸ“ POSTç«¯ç‚¹ç¤ºä¾‹ï¼ˆå‰10ä¸ªï¼‰:")
		count := 0
		for postURL := range uniquePOSTURLs {
			if count >= 10 {
				break
			}
			count++
			fmt.Printf("  %d. %s\n", count, postURL)
		}
		
		if len(uniquePOSTURLs) > 10 {
			fmt.Printf("  ... è¿˜æœ‰ %d ä¸ª\n", len(uniquePOSTURLs)-10)
		}
	}
	
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
}

// PrintLoginWallReport æ‰“å°ç™»å½•å¢™æ£€æµ‹æŠ¥å‘Š
func (s *Spider) PrintLoginWallReport() {
	if s.loginWallDetector != nil {
		s.loginWallDetector.PrintSummary()
	}
}

// PrintRedirectReport æ‰“å°é‡å®šå‘æ£€æµ‹æŠ¥å‘Š
func (s *Spider) PrintRedirectReport() {
	if s.redirectManager != nil {
		s.redirectManager.PrintReport()
	}
}

// GetRedirectManager è·å–é‡å®šå‘ç®¡ç†å™¨
func (s *Spider) GetRedirectManager() *RedirectManager {
	return s.redirectManager
}

// CollectAllURLsForStructureDedup æ”¶é›†æ‰€æœ‰URLå¹¶æ·»åŠ åˆ°ç»“æ„åŒ–å»é‡å™¨
// è¯¥æ–¹æ³•åº”åœ¨çˆ¬å–å®Œæˆåè°ƒç”¨ï¼Œç”¨äºåˆ†æå’Œå»é‡æ‰€æœ‰å‘ç°çš„URL
func (s *Spider) CollectAllURLsForStructureDedup() {
	if s.urlStructureDedup == nil {
		return
	}
	
	s.mutex.Lock()
	defer s.mutex.Unlock()
	
	// æ”¶é›†æ‰€æœ‰URLï¼ˆåªæ”¶é›†ç›®æ ‡åŸŸåçš„URLï¼‰
	for _, result := range s.results {
		// æ·»åŠ é¡µé¢URL
		if s.isInTargetDomain(result.URL) {
			s.urlStructureDedup.AddURL(result.URL)
		}
		
		// æ·»åŠ å‘ç°çš„é“¾æ¥ï¼ˆåªæ·»åŠ åŸŸå†…çš„ï¼‰
		for _, link := range result.Links {
			if s.isInTargetDomain(link) {
				s.urlStructureDedup.AddURL(link)
			}
		}
		
		// æ·»åŠ APIï¼ˆåªæ·»åŠ åŸŸå†…çš„ï¼‰
		for _, api := range result.APIs {
			if s.isInTargetDomain(api) {
				s.urlStructureDedup.AddURL(api)
			}
		}
		
		// æ·»åŠ è¡¨å•URLï¼ˆåªæ·»åŠ åŸŸå†…çš„ï¼‰
		for _, form := range result.Forms {
			if form.Action != "" && s.isInTargetDomain(form.Action) {
				s.urlStructureDedup.AddURL(form.Action)
			}
		}
	}
}

// filterBySeverity æŒ‰ä¸¥é‡çº§åˆ«è¿‡æ»¤æ•æ„Ÿä¿¡æ¯å‘ç°
func (s *Spider) filterBySeverity(findings []*SensitiveInfo) []*SensitiveInfo {
	minSeverity := s.config.SensitiveDetectionSettings.MinSeverity
	
	// å¦‚æœè®¾ç½®ä¸ºLOWï¼Œè¿”å›æ‰€æœ‰å‘ç°
	if minSeverity == "LOW" || minSeverity == "" {
		return findings
	}
	
	filtered := make([]*SensitiveInfo, 0)
	for _, finding := range findings {
		if minSeverity == "MEDIUM" {
			// åªè¿”å›MEDIUMå’ŒHIGH
			if finding.Severity == "MEDIUM" || finding.Severity == "HIGH" {
				filtered = append(filtered, finding)
			}
		} else if minSeverity == "HIGH" {
			// åªè¿”å›HIGH
			if finding.Severity == "HIGH" {
				filtered = append(filtered, finding)
			}
		}
	}
	
	return filtered
}

// URLWithPriority URLä¼˜å…ˆçº§ä¿¡æ¯ï¼ˆç”¨äºæ··åˆç­–ç•¥ï¼‰
type URLWithPriority struct {
	URL      string
	Priority float64
	Depth    int
}

// crawlWithHybridStrategy ğŸ†• v3.4 æ··åˆè°ƒåº¦ç­–ç•¥çˆ¬å–ï¼ˆBFSæ¡†æ¶+æ™ºèƒ½ä¼˜å…ˆçº§æ’åºï¼‰
func (s *Spider) crawlWithHybridStrategy() {
	fmt.Println("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ã€æ··åˆè°ƒåº¦ç­–ç•¥ã€‘BFSæ¡†æ¶ + æ™ºèƒ½ä¼˜å…ˆçº§æ’åº")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("âœ¨ ç»“åˆBFSå…¨é¢æ€§å’Œä¼˜å…ˆçº§æ™ºèƒ½æ€§")
	fmt.Println("âœ¨ è‡ªé€‚åº”å­¦ä¹ ï¼Œè¶Šçˆ¬è¶Šèªæ˜")
	fmt.Println("")
	
	currentDepth := 1
	totalCrawled := 0
	
	// å¾ªç¯çˆ¬å–æ¯ä¸€å±‚
	for currentDepth < s.config.DepthSettings.MaxDepth {
		currentDepth++
		
		fmt.Printf("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
		fmt.Printf("ã€ç¬¬ %d å±‚çˆ¬å–ã€‘æ··åˆç­–ç•¥æ¨¡å¼ | æœ€å¤§æ·±åº¦: %d\n", currentDepth, s.config.DepthSettings.MaxDepth)
		fmt.Printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
		
		// 1. æ”¶é›†å½“å‰å±‚çš„æ‰€æœ‰URLï¼ˆBFSæ¡†æ¶ï¼‰
		layerURLs := s.collectLinksForLayer(currentDepth)
		
		if len(layerURLs) == 0 {
			fmt.Printf("ç¬¬ %d å±‚æ²¡æœ‰æ–°é“¾æ¥ï¼Œçˆ¬å–ç»“æŸ\n", currentDepth)
			break
		}
		
		fmt.Printf("æ”¶é›†åˆ° %d ä¸ªå€™é€‰URL\n", len(layerURLs))
		
		// 2. è®¡ç®—æ¯ä¸ªURLçš„ç²¾ç¡®ä¼˜å…ˆçº§
		urlsWithPriority := s.calculateURLPriorities(layerURLs, currentDepth)
		
		// 3. æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆé«˜ä¼˜å…ˆçº§åœ¨å‰ï¼‰
		sort.Slice(urlsWithPriority, func(i, j int) bool {
			return urlsWithPriority[i].Priority > urlsWithPriority[j].Priority
		})
		
		// 4. åº”ç”¨å±‚çº§é™åˆ¶ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
		maxURLs := s.config.SchedulingSettings.HybridConfig.MaxURLsPerLayer
		originalCount := len(urlsWithPriority)
		if maxURLs > 0 && len(urlsWithPriority) > maxURLs {
			// ä¿ç•™é«˜ä¼˜å…ˆçº§çš„URL
			urlsWithPriority = urlsWithPriority[:maxURLs]
			fmt.Printf("  [æ™ºèƒ½é™åˆ¶] æœ¬å±‚é™åˆ¶çˆ¬å–å‰ %d ä¸ªé«˜ä¼˜å…ˆçº§URLï¼ˆåŸå§‹: %dä¸ªï¼‰\n", maxURLs, originalCount)
		}
		
		// 5. å±•ç¤ºæœ¬å±‚ä¼˜å…ˆçº§TOP5
		s.showLayerPriorityTop(urlsWithPriority, 5)
		
		// 6. çˆ¬å–ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰
		results := s.crawlLayerWithPriority(urlsWithPriority, currentDepth)
		
		// 7. è‡ªé€‚åº”å­¦ä¹ ï¼ˆæ ¹æ®çˆ¬å–ç»“æœè°ƒæ•´æƒé‡ï¼‰
		if s.adaptiveLearner != nil {
			s.adaptiveLearner.LearnFromResults(results)
			
			// æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒæ•´æƒé‡
			if shouldAdjust, reason := s.adaptiveLearner.ShouldAdjustWeights(); shouldAdjust {
				fmt.Printf("\nğŸ¤– [è‡ªé€‚åº”å­¦ä¹ ] %s\n", reason)
				if s.adaptiveLearner.AdjustWeights(s.priorityScheduler) {
					fmt.Println("âœ… æƒé‡å·²ä¼˜åŒ–ï¼Œä¸‹ä¸€å±‚å°†ä½¿ç”¨æ–°æƒé‡")
				}
			}
		}
		
		// 8. åˆå¹¶ç»“æœ
		s.mutex.Lock()
		s.results = append(s.results, results...)
		s.mutex.Unlock()
		
		totalCrawled += len(results)
		
		fmt.Printf("\nç¬¬ %d å±‚å®Œæˆï¼çˆ¬å– %d ä¸ªURLï¼Œç´¯è®¡ %d ä¸ª\n", 
			currentDepth, len(results), totalCrawled)
		
		// æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é™åˆ¶
		if totalCrawled >= 500 {
			fmt.Printf("å·²è¾¾åˆ°URLé™åˆ¶(500)ï¼Œçˆ¬å–ç»“æŸ\n")
			break
		}
	}
	
	fmt.Printf("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	fmt.Printf("ã€æ··åˆç­–ç•¥çˆ¬å–å®Œæˆã€‘\n")
	fmt.Printf("æ€»æ·±åº¦: %d å±‚ | æ€»URL: %d ä¸ª\n", currentDepth, totalCrawled)
	fmt.Printf("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
}

// calculateURLPriorities è®¡ç®—URLåˆ—è¡¨çš„ä¼˜å…ˆçº§
func (s *Spider) calculateURLPriorities(urls []string, depth int) []*URLWithPriority {
	result := make([]*URLWithPriority, 0, len(urls))
	
	// è·å–æƒé‡é…ç½®
	weights := s.config.SchedulingSettings.HybridConfig.PriorityWeights
	
	for _, urlStr := range urls {
		// åŸºç¡€ä¼˜å…ˆçº§ï¼ˆæ¥è‡ªPrioritySchedulerï¼‰
		basePriority := s.priorityScheduler.CalculatePriority(urlStr, depth)
		
		// ä¸šåŠ¡ä»·å€¼åŠ æˆï¼ˆæ¥è‡ªBusinessAwareFilterï¼‰
		businessBonus := 0.0
		if s.businessFilter != nil && s.config.DeduplicationSettings.EnableBusinessAwareFilter {
			_, _, businessScore := s.businessFilter.ShouldCrawlURL(urlStr)
			// å°†ä¸šåŠ¡åˆ†æ•°ï¼ˆ0-100ï¼‰è½¬æ¢ä¸ºä¼˜å…ˆçº§åŠ æˆ
			businessBonus = (businessScore / 100.0) * weights.BusinessValue * 10
		}
		
		// æœ€ç»ˆä¼˜å…ˆçº§ = åŸºç¡€ä¼˜å…ˆçº§ + ä¸šåŠ¡åŠ æˆ
		finalPriority := basePriority + businessBonus
		
		result = append(result, &URLWithPriority{
			URL:      urlStr,
			Priority: finalPriority,
			Depth:    depth,
		})
	}
	
	return result
}

// showLayerPriorityTop å±•ç¤ºæœ¬å±‚ä¼˜å…ˆçº§TOP N
func (s *Spider) showLayerPriorityTop(urls []*URLWithPriority, topN int) {
	if len(urls) == 0 {
		return
	}
	
	fmt.Printf("\n  [ä¼˜å…ˆçº§TOP%d] æœ¬å±‚æœ€é«˜ä»·å€¼URL:\n", topN)
	
	displayCount := topN
	if len(urls) < topN {
		displayCount = len(urls)
	}
	
	for i := 0; i < displayCount; i++ {
		item := urls[i]
		fmt.Printf("    %d. [ä¼˜å…ˆçº§: %.2f] %s\n", i+1, item.Priority, item.URL)
	}
	
	if len(urls) > displayCount {
		fmt.Printf("    ... è¿˜æœ‰ %d ä¸ªURLæŒ‰ä¼˜å…ˆçº§æ’åº\n", len(urls)-displayCount)
	}
	fmt.Println()
}

// crawlLayerWithPriority æŒ‰ä¼˜å…ˆçº§é¡ºåºçˆ¬å–ä¸€å±‚çš„URL
func (s *Spider) crawlLayerWithPriority(urlsWithPriority []*URLWithPriority, depth int) []*Result {
	if len(urlsWithPriority) == 0 {
		return []*Result{}
	}
	
	// æå–URLåˆ—è¡¨
	urls := make([]string, 0, len(urlsWithPriority))
	for _, item := range urlsWithPriority {
		urls = append(urls, item.URL)
	}
	
	// æ ‡è®°ä¸ºå·²è®¿é—®
	s.mutex.Lock()
	for _, url := range urls {
		s.visitedURLs[url] = true
	}
	s.mutex.Unlock()
	
	// åˆ›å»ºå·¥ä½œæ± ï¼ˆå¤ç”¨ç°æœ‰çš„crawlLayeré€»è¾‘ï¼‰
	return s.crawlLayer(urls, depth)
}

// crawlWithPriorityQueue ğŸ†• ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—æ¨¡å¼çˆ¬å–ï¼ˆå®éªŒæ€§ï¼‰
func (s *Spider) crawlWithPriorityQueue() {
	fmt.Println("\nå¼€å§‹ä¼˜å…ˆçº§é˜Ÿåˆ—æ¨¡å¼çˆ¬å–...")
	fmt.Println("ç®—æ³•ï¼šçº¯ä¼˜å…ˆçº§é˜Ÿåˆ—è°ƒåº¦ï¼ˆå®éªŒæ€§ï¼‰")
	
	// å°†æ‰€æœ‰å·²å‘ç°çš„URLæ·»åŠ åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—
	s.mutex.Lock()
	for _, result := range s.results {
		for _, link := range result.Links {
			// è®¡ç®—æ·±åº¦ï¼ˆç®€åŒ–ï¼šéƒ½è§†ä¸ºæ·±åº¦2ï¼‰
			s.priorityScheduler.AddURL(link, 2)
		}
	}
	s.mutex.Unlock()
	
	fmt.Printf("ä¼˜å…ˆçº§é˜Ÿåˆ—åˆå§‹åŒ–å®Œæˆï¼Œé˜Ÿåˆ—å¤§å°: %d\n", s.priorityScheduler.Size())
	
	totalCrawled := 0
	maxURLs := 500 // é™åˆ¶æœ€å¤§çˆ¬å–æ•°é‡
	
	// å¾ªç¯ä»é˜Ÿåˆ—ä¸­å–URLçˆ¬å–
	for totalCrawled < maxURLs && s.priorityScheduler.Size() > 0 {
		// æ‰¹é‡å–å‡ºé«˜ä¼˜å…ˆçº§URL
		batchSize := 30 // æ¯æ‰¹30ä¸ªï¼ˆåŒ¹é…workeræ•°é‡ï¼‰
		batch := s.priorityScheduler.PopBatch(batchSize)
		
		if len(batch) == 0 {
			break
		}
		
		fmt.Printf("\næ‰¹æ¬¡çˆ¬å–: %dä¸ªURLï¼ˆä¼˜å…ˆçº§æ’åºï¼‰\n", len(batch))
		
		// æ˜¾ç¤ºå‰3ä¸ªURLçš„ä¼˜å…ˆçº§
		for i := 0; i < len(batch) && i < 3; i++ {
			fmt.Printf("  [ä¼˜å…ˆçº§: %.2f] %s\n", batch[i].Priority, batch[i].URL)
		}
		if len(batch) > 3 {
			fmt.Printf("  ... è¿˜æœ‰ %d ä¸ªURL\n", len(batch)-3)
		}
		
		// æå–URLåˆ—è¡¨
		urls := make([]string, 0, len(batch))
		for _, item := range batch {
			urls = append(urls, item.URL)
		}
		
		// çˆ¬å–è¿™æ‰¹URL
		newResults := s.crawlLayer(urls, batch[0].Depth)
		
		// åˆå¹¶ç»“æœ
		s.mutex.Lock()
		s.results = append(s.results, newResults...)
		
		// å°†æ–°å‘ç°çš„URLæ·»åŠ åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—
		for _, result := range newResults {
			for _, newLink := range result.Links {
				if !s.priorityScheduler.IsVisited(newLink) {
					// æ–°é“¾æ¥çš„æ·±åº¦ = å½“å‰æ·±åº¦ + 1
					newDepth := batch[0].Depth + 1
					if newDepth <= s.config.DepthSettings.MaxDepth {
						s.priorityScheduler.AddURL(newLink, newDepth)
					}
				}
			}
		}
		s.mutex.Unlock()
		
		totalCrawled += len(batch)
		fmt.Printf("å·²çˆ¬å–: %dä¸ªï¼Œé˜Ÿåˆ—å‰©ä½™: %dä¸ª\n", totalCrawled, s.priorityScheduler.Size())
		
		// æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§æ·±åº¦
		if batch[0].Depth >= s.config.DepthSettings.MaxDepth {
			fmt.Printf("å·²è¾¾åˆ°æœ€å¤§æ·±åº¦ %dï¼Œåœæ­¢çˆ¬å–\n", s.config.DepthSettings.MaxDepth)
			break
		}
	}
	
	// æ‰“å°æœ€ç»ˆç»Ÿè®¡
	fmt.Printf("\nä¼˜å…ˆçº§é˜Ÿåˆ—çˆ¬å–å®Œæˆï¼æ€»å…±çˆ¬å– %d ä¸ªURL\n", totalCrawled)
	s.priorityScheduler.PrintStatistics()
}
